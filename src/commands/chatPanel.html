<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lollms Chat</title>
    <link href="{{codiconsUri}}" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    
    <style>
        :root {
            --code-bg: #1e1e1e;
            --code-border: #3e3e3e;
            --progress-green: #2ecc71;
            --progress-yellow: #f1c40f;
            --progress-red: #e74c3c;
        }
        body { 
            font-family: var(--vscode-font-family); 
            padding: 0;
            margin: 0;
            background-color: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
            overflow: hidden; /* Prevent body scroll */
        }
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .search-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background-color: var(--vscode-editorWidget-background);
            border-bottom: 1px solid var(--vscode-panel-border);
            position: sticky;
            top: -10px; /* Counteract padding */
            margin: -10px -10px 10px -10px;
            z-index: 10;
        }
        #searchInput {
            flex-grow: 1;
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            color: var(--vscode-input-foreground);
            padding: 4px 8px;
            border-radius: 4px;
        }
        #search-results-count {
            font-size: 0.9em;
            color: var(--vscode-description-foreground);
        }
        .search-bar button {
            background: none;
            border: none;
            color: var(--vscode-icon-foreground);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        .search-bar button:hover {
            background-color: var(--vscode-toolbar-hoverBackground);
        }
        mark {
            background-color: var(--vscode-editor-findMatchHighlightBackground);
            color: var(--vscode-editor-foreground);
            border-radius: 2px;
        }
        mark.current-match {
            background-color: var(--vscode-editor-findMatchBackground);
            outline: 1px solid var(--vscode-editor-findMatchBorder);
        }
        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            position: relative;
            width: 95%;
            max-width: 100%;
        }
        .user-message {
            background-color: var(--vscode-inputOption-activeBackground);
            border-left: 4px solid var(--vscode-inputOption-activeBorder);
            align-self: flex-end;

        }
        .assistant-message {
            background-color: var(--vscode-textBlockQuote-background);
            border-left: 4px solid var(--vscode-textBlockQuote-border);
            align-self: flex-start;
        }
        .system-message {
            background-color: var(--vscode-editor-background);
            border: 1px dashed var(--vscode-panel-border);
            font-size: 0.9em;
            opacity: 0.8;
            align-self: center;
            width: 95%;
        }
        .message-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--vscode-textPreformat-foreground);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .message-content {
            line-height: 1.6;
            word-wrap: break-word;
        }

        .code-collapsible {
            background-color: var(--code-bg);
            border: 1px solid var(--code-border);
            border-radius: 8px;
            margin: 12px 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .code-collapsible > pre {
            max-height: 450px;
            overflow-y: auto;
            margin: 0;
            border-top: 1px solid var(--code-border);
        }
        .code-collapsible > pre > code {
            background: transparent !important;
            padding: 16px !important;
            display: block;
            overflow-x: auto;
            font-family: var(--vscode-editor-font-family);
            font-size: 13px;
            line-height: 1.5;
            color: #D4D4D4;
        }
        .code-summary {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background-color: var(--vscode-editorGroupHeader-tabsBackground);
            color: var(--vscode-tab-activeForeground);
            cursor: pointer;
            list-style: none;
        }
        .code-summary::-webkit-details-marker {
            display: none;
        }
        .code-summary::before {
            content: '▼';
            font-size: 0.9em;
            transition: transform 0.2s;
            color: var(--vscode-icon-foreground);
        }
        details[open] > .code-summary::before {
            transform: rotate(-90deg);
        }
        .summary-lang-label {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .code-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        .code-action-btn, .msg-action-btn {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .code-action-btn:hover, .msg-action-btn:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }
        .apply-btn {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        .apply-btn:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        .input-area-wrapper {
            padding: 10px;
            background-color: var(--vscode-panel-background);
            border-top: 1px solid var(--vscode-panel-border);
        }
        .top-controls {
            display: flex;
            justify-content: space-between; /* Adjusted */
            align-items: center;
            margin-bottom: 8px;
            gap: 15px; /* Added */
        }
        .token-progress {
            flex-grow: 1; /* Added */
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .token-progress-container {
            flex-grow: 1;
            height: 6px;
            background-color: var(--vscode-input-background);
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid var(--vscode-input-border);
        }
        .token-progress-bar {
            height: 100%;
            width: 0%;
            border-radius: 3px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        .token-progress-bar.green { background-color: var(--progress-green); }
        .token-progress-bar.yellow { background-color: var(--progress-yellow); }
        .token-progress-bar.red { background-color: var(--progress-red); }
        #token-count-label {
            font-size: 0.85em;
            color: var(--vscode-descriptionForeground);
            white-space: nowrap;
        }
        .input-area {
            display: flex;
            gap: 8px;
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 6px;
            padding: 4px;
        }
        .input-area:focus-within {
            border-color: var(--vscode-focusBorder);
        }
        #messageInput {
            flex-grow: 1;
            border: none;
            background-color: transparent;
            color: var(--vscode-input-foreground);
            padding: 8px;
            font-size: 14px;
            font-family: var(--vscode-font-family);
            resize: none;
            line-height: 1.6;
            max-height: 200px;
            outline: none;
        }
        #messageInput:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .control-buttons button {
            background: none;
            border: none;
            color: var(--vscode-icon-foreground);
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 4px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .control-buttons button:hover {
            background-color: var(--vscode-toolbar-hoverBackground);
        }
        .control-buttons button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        #sendButton {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        #sendButton:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        #stopButton {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }
        #stopButton:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }
        .spinner {
            border: 2px solid var(--vscode-panel-border);
            border-top: 2px solid var(--vscode-focusBorder);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-actions {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            gap: 5px;
        }
        .message:hover .message-actions {
            display: flex;
        }
        .msg-action-btn {
            background: var(--vscode-sideBar-background);
            opacity: 0.7;
        }
        .msg-action-btn:hover {
            opacity: 1;
        }
        .agent-mode-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: var(--vscode-descriptionForeground);
            white-space: nowrap; /* Prevent wrapping */
        }
        .agent-mode-toggle.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        .switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--vscode-input-border);
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 12px; width: 12px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--vscode-button-background); }
        input:checked + .slider:before { transform: translateX(14px); }
        
        .plan-wrapper {
            width: 95%;
            align-self: center;
            margin-bottom: 15px;
        }
        .plan-container-details {
            border: 1px solid var(--vscode-panel-border);
            border-radius: 8px;
            background-color: var(--vscode-sideBar-background);
        }
        .plan-header {
            padding: 10px 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            list-style: none;
        }
        .plan-header::-webkit-details-marker { display: none; }
        .plan-header::before {
            content: '▶';
            transition: transform 0.2s;
            font-size: 0.8em;
        }
        details[open] > .plan-header::before {
            transform: rotate(90deg);
        }
        .plan-objective {
            font-size: 0.9em;
            font-weight: normal;
            color: var(--vscode-descriptionForeground);
            margin-top: 5px;
            padding: 0 15px 10px 15px;
        }
        .plan-body {
            padding: 5px 15px 15px 15px;
        }
        .plan-task {
            padding: 8px 0;
            border-bottom: 1px solid var(--vscode-editorWidget-background);
        }
        .plan-task:last-child { border-bottom: none; }
        .plan-task-header {
            display: flex;
            align-items: center;
        }
        .task-status {
            width: 24px;
            text-align: center;
            margin-right: 10px;
            font-size: 16px;
        }
        .task-status .codicon-sync.spin { animation: spin 1.5s linear infinite; }
        .task-status .codicon-check { color: var(--vscode-testing-iconPassed); }
        .task-status .codicon-error { color: var(--vscode-testing-iconFailed); }
        .task-status .codicon-circle-large-filled { 
            color: var(--vscode-descriptionForeground); 
            font-size: 12px;
            vertical-align: middle;
         }
        
        .task-description { flex: 1; }
        .task-result-details {
            margin-top: 8px;
            padding-left: 34px;
        }
        .task-result-details summary {
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--vscode-descriptionForeground);
            list-style-position: inside;
        }
        .task-result-content {
            margin-top: 5px;
            background-color: var(--vscode-textCodeBlock-background);
            border-radius: 4px;
            padding: 8px 12px;
            max-height: 200px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: var(--vscode-editor-font-family);
            font-size: 0.9em;
        }
        details.info-collapsible {
            border: 1px solid var(--vscode-panel-border);
            border-radius: 6px;
            background-color: var(--vscode-sideBar-background);
            margin: 0 auto 15px auto;
            width: 95%;
        }
        details.info-collapsible > summary {
            padding: 10px;
            cursor: pointer;
            font-weight: 600;
            list-style: none;
        }
        details.info-collapsible > summary::-webkit-details-marker { display: none; }
        details.info-collapsible > summary::before {
            content: '▶';
            margin-right: 8px;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
        .collapsible-content {
            padding: 0 10px 10px 10px;
            background-color: var(--vscode-editor-background);
            border-top: 1px solid var(--vscode-panel-border);
            max-height: 400px;
            overflow-y: auto;
        }
        .collapsible-content pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: var(--vscode-editor-font-family);
            font-size: 0.9em;
            background-color: var(--vscode-textCodeBlock-background);
            padding: 10px;
            border-radius: 4px;
        }
        .attachment-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .remove-attachment-btn {
            background: none; border: none; cursor: pointer;
            color: var(--vscode-icon-foreground); padding: 2px 5px; border-radius: 3px;
        }
        .remove-attachment-btn:hover { background-color: var(--vscode-toolbar-hoverBackground); }
        .collapsible-content img { max-width: 100%; border-radius: 4px; margin-top: 5px; }

        #welcome-message {
            padding: 15px;
            background-color: var(--vscode-textBlockQuote-background);
            border-radius: 6px;
            margin: 0 auto 15px auto;
            font-size: 0.95em;
            width: 95%;
            border-left: 4px solid var(--vscode-focusBorder);
        }
        #welcome-message ul { padding-left: 20px; margin: 10px 0 0 0; }
        #welcome-message li { margin-bottom: 5px; }

        .plan-scratchpad {
            font-size: 0.9em;
            color: var(--vscode-descriptionForeground);
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--vscode-panel-border);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .plan-scratchpad h3 { margin-top: 0; font-size: 1em; font-weight: 600; }
        #chat-messages-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .thinking-collapsible {
            background-color: var(--vscode-editorWidget-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .edit-overlay {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background-color: var(--vscode-editor-background);
        }
        .edit-textarea {
            flex: 1;
            resize: none;
            border: 1px solid var(--vscode-input-border);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            padding: 8px;
            font-family: var(--vscode-font-family);
            font-size: 14px;
            line-height: 1.6;
            outline: none;
            border-radius: 4px;
        }
        .edit-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .edit-save-btn, .edit-cancel-btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        .edit-save-btn {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        .edit-cancel-btn {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }
        .edit-save-btn:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        .edit-cancel-btn:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }
        .code-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        .code-action-btn, .msg-action-btn {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="messages" id="messages">
            <div class="search-bar" id="search-bar" style="display: none;">
                <input type="text" id="searchInput" placeholder="Search discussion...">
                <span id="search-results-count"></span>
                <button id="search-prev" title="Previous match"><i class="codicon codicon-arrow-up"></i></button>
                <button id="search-next" title="Next match"><i class="codicon codicon-arrow-down"></i></button>
                <button id="search-close" title="Close search"><i class="codicon codicon-close"></i></button>
            </div>
            
            <div id="context-container"></div>
            <div id="attachments-container"></div>
            
            <div id="welcome-message" style="display: none;">
                <h3>{{welcomeTitle}}</h3>
                <ul>
                    <li>{{welcomeItem1}}</li>
                    <li>{{welcomeItem2}}</li>
                    <li>{{welcomeItem3}}</li>
                    <li>{{welcomeItem4}}</li>
                </ul>
            </div>

            <div id="chat-messages-container"></div>

        </div>
        <div class="input-area-wrapper">
            <div class="top-controls">
                <div class="token-progress">
                    <div class="token-progress-container">
                        <div class="token-progress-bar" id="token-progress-bar"></div>
                    </div>
                    <span id="token-count-label">Tokens: 0 / 0</span>
                </div>
                <div class="agent-mode-toggle">
                    <span>🤖 Agent Mode</span>
                    <label class="switch">
                        <input type="checkbox" id="agentModeCheckbox">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="input-area">
                <button id="attachButton" title="Attach Files"><i class="codicon codicon-add"></i></button>
                <button id="executeButton" title="Execute Project (F5)"><i class="codicon codicon-play"></i></button>
                <textarea id="messageInput" placeholder="Enter your message (Shift+Enter for new line)..." rows="1"></textarea>
                <div class="control-buttons">
                    <button id="sendButton" title="Send Message"><i class="codicon codicon-send"></i></button>
                    <button id="stopButton" title="Stop Generation" style="display: none;">
                        <div class="spinner"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none;" multiple accept=".md,.txt,.msg,.docx,.pdf,.pptx,.xlsx,.csv,.png,.jpg,.jpeg,.bmp,.webp">

    <script src="https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>


    <script>
        const vscode = acquireVsCodeApi();
        const messagesDiv = document.getElementById('messages');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const stopButton = document.getElementById('stopButton');
        const attachButton = document.getElementById('attachButton');
        const executeButton = document.getElementById('executeButton');
        const fileInput = document.getElementById('fileInput');
        const agentModeCheckbox = document.getElementById('agentModeCheckbox');
        const agentModeToggle = document.querySelector('.agent-mode-toggle');
        const contextContainer = document.getElementById('context-container');
        const attachmentsContainer = document.getElementById('attachments-container');
        const welcomeMessage = document.getElementById('welcome-message');
        
        const tokenProgressBar = document.getElementById('token-progress-bar');
        const tokenCountLabel = document.getElementById('token-count-label');

        const searchBar = document.getElementById('search-bar');
        const searchInput = document.getElementById('searchInput');
        const searchResultsCount = document.getElementById('search-results-count');
        const searchPrevBtn = document.getElementById('search-prev');
        const searchNextBtn = document.getElementById('search-next');
        const searchCloseBtn = document.getElementById('search-close');

        let searchMatches = [];
        let currentMatchIndex = -1;
        let isInspectorEnabled = false;


        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false
        });
        
        function processThinkTags(content) {
            const thoughts = [];
            const thinkRegex = /<(think|thinking)>([\s\S]*?)<\/\1>/g;
            const processedContent = content.replace(thinkRegex, (match, tag, thoughtContent) => {
                thoughts.push(thoughtContent);
                return ''; // Remove the block from the main content
            });
            return { thoughts, processedContent: processedContent.trim() };
        }

        function startEdit(messageDiv, messageId, role) {
            const contentDiv = messageDiv.querySelector('.message-content');
            const originalContent = messageDiv.dataset.originalContent;
            const editOverlay = document.createElement('div');
            editOverlay.className = 'edit-overlay';
            editOverlay.innerHTML = `
                <textarea class="edit-textarea">${originalContent}</textarea>
                <div class="edit-buttons">
                    <button class="edit-cancel-btn">Cancel</button>
                    <button class="edit-save-btn">Save</button>
                </div>
            `;
            contentDiv.style.display = 'none';
            messageDiv.appendChild(editOverlay);
            const textarea = editOverlay.querySelector('.edit-textarea');
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            });
            setTimeout(() => { // ensure it's rendered to calc scrollHeight
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            }, 0);
            const saveBtn = editOverlay.querySelector('.edit-save-btn');
            const cancelBtn = editOverlay.querySelector('.edit-cancel-btn');
            saveBtn.onclick = () => saveEdit(messageDiv, contentDiv, editOverlay, textarea.value, messageId, role);
            cancelBtn.onclick = () => {
                editOverlay.remove();
                contentDiv.style.display = 'block';
            };
            textarea.focus();
        }

        function saveEdit(messageDiv, contentDiv, editOverlay, newContent, messageId, role) {
            // Remove existing thoughts
            messageDiv.querySelectorAll('.thinking-collapsible').forEach(el => el.remove());
            let processedContent = newContent;
            let thoughts = [];
            if (role === 'assistant') {
                const res = processThinkTags(newContent);
                thoughts = res.thoughts;
                processedContent = res.processedContent;
            }
            if (thoughts.length > 0) {
                thoughts.forEach(thought => {
                    const details = document.createElement('details');
                    details.className = 'info-collapsible thinking-collapsible';
                    details.innerHTML = `
                        <summary>🤔 Thinking Process</summary>
                        <div class="collapsible-content">${DOMPurify.sanitize(marked.parse(thought))}</div>
                    `;
                    messageDiv.insertBefore(details, contentDiv);
                });
            }
            contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(processedContent));
            enhanceCodeBlocks(messageDiv.parentElement);
            messageDiv.dataset.originalContent = newContent;
            editOverlay.remove();
            contentDiv.style.display = 'block';
            vscode.postMessage({ command: 'updateMessage', messageId, newContent });
        }
        
        function addMessage(message) {
            if (message.id && message.id.startsWith('attachment_')) {
                addAttachment(message);
            } else {
                addChatMessage(message);
            }
        }

        function addAttachment(message) {
            if (document.querySelector(`.attachment-details[data-message-id='${message.id}']`)) return;

            const details = document.createElement('details');
            details.className = 'info-collapsible attachment-details';
            details.dataset.messageId = message.id;

            const summary = document.createElement('summary');
            summary.className = 'attachment-summary';
            const summaryText = document.createElement('span');
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-attachment-btn';
            removeBtn.innerHTML = '<i class="codicon codicon-trash"></i>';
            removeBtn.title = 'Remove Attachment';
            removeBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                vscode.postMessage({ command: 'requestDeleteMessage', messageId: message.id });
            };

            const contentDiv = document.createElement('div');
            contentDiv.className = 'collapsible-content';
            
            let fileName = 'file';
            let fileContentHtml = '';

            if (Array.isArray(message.content)) {
                const textPart = message.content.find(p => p.type === 'text');
                const imagePart = message.content.find(p => p.type === 'image_url');
                
                if (imagePart) { // Image
                    if (textPart && typeof textPart.text === 'string') {
                        fileName = textPart.text.replace('Attached image: ', '');
                    }
                    summaryText.textContent = `📎 Attached Image: ${fileName}`;
                    fileContentHtml = `<img src="${imagePart.image_url.url}" alt="${fileName}">`;
                } else { // Text file (messy structure)
                    const titlePart = message.content[0];
                    const contentPart = message.content[1];
                    if (titlePart && typeof titlePart.text === 'string') {
                         fileName = titlePart.text.replace('Attached file: ', '').trim();
                    }
                    summaryText.textContent = `📎 Attached File: ${fileName}`;
                    
                    let code = 'Could not display file content.';
                    if(contentPart && typeof contentPart.text === 'string') {
                        const codeBlockRegex = /```\\n([\\s\\S]+?)\\n```/; // Adjusted regex for escaped newlines
                        const match = contentPart.text.match(codeBlockRegex);
                        if (match && match[1]) {
                            code = match[1].replace(/\\n/g, '\\n');
                        } else {
                            code = contentPart.text.replace(/^```\w*\\n|\\n```$/g, '').replace(/\\n/g, '\\n');
                        }
                    }
                    fileContentHtml = `<pre>${DOMPurify.sanitize(code)}</pre>`;
                }

            }
            
            summary.appendChild(summaryText);
            summary.appendChild(removeBtn);
            contentDiv.innerHTML = fileContentHtml;
            details.appendChild(summary);
            details.appendChild(contentDiv);
            attachmentsContainer.appendChild(details);
        }

        function addChatMessage(message) {
            const role = message.role;
            let rawContent = message.content;
            let displayContent = message.content;
            let thoughtElements = [];
            if (role === 'assistant') {
                const { thoughts, processedContent } = processThinkTags(rawContent);
                displayContent = processedContent;
                thoughtElements = thoughts.map(thought => {
                    const details = document.createElement('details');
                    details.className = 'info-collapsible thinking-collapsible';
                    details.innerHTML = `
                        <summary>🤔 Thinking Process</summary>
                        <div class="collapsible-content">${DOMPurify.sanitize(marked.parse(thought))}</div>
                    `;
                    return details;
                });
            }
            
            const existingMsgWrapper = chatMessagesContainer.querySelector(`.message-wrapper[data-message-id='${message.id}']`);
            if (existingMsgWrapper) {
                const messageDiv = existingMsgWrapper.querySelector('.message');
                const contentDiv = messageDiv.querySelector('.message-content');
                // Remove existing thoughts
                messageDiv.querySelectorAll('.thinking-collapsible').forEach(el => el.remove());
                let updateRawContent = message.content;
                let updateDisplayContent = message.content;
                let updateThoughtElements = [];
                if (role === 'assistant') {
                    const { thoughts, processedContent } = processThinkTags(updateRawContent);
                    updateDisplayContent = processedContent;
                    updateThoughtElements = thoughts.map(thought => {
                        const details = document.createElement('details');
                        details.className = 'info-collapsible thinking-collapsible';
                        details.innerHTML = `
                            <summary>🤔 Thinking Process</summary>
                            <div class="collapsible-content">${DOMPurify.sanitize(marked.parse(thought))}</div>
                        `;
                        return details;
                    });
                }
                updateThoughtElements.forEach(el => messageDiv.insertBefore(el, contentDiv));
                contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(updateDisplayContent));
                messageDiv.dataset.originalContent = updateRawContent;
                enhanceCodeBlocks(existingMsgWrapper);
                return;
            }

            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper';
            messageWrapper.dataset.messageId = message.id;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            headerDiv.textContent = role;
            
            messageDiv.appendChild(headerDiv);

            thoughtElements.forEach(el => messageDiv.appendChild(el));

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(displayContent));

            messageDiv.dataset.originalContent = rawContent;

            // Add message actions
            const actions = document.createElement('div');
            actions.className = 'message-actions';

            const copyBtn = document.createElement('button');
            copyBtn.className = 'msg-action-btn';
            copyBtn.innerHTML = '📋';
            copyBtn.title = 'Copy Message';
            copyBtn.onclick = async () => {
                await navigator.clipboard.writeText(rawContent);
                copyBtn.innerHTML = '✅';
                setTimeout(() => { copyBtn.innerHTML = '📋'; }, 2000);
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'msg-action-btn';
            deleteBtn.innerHTML = '🗑️';
            deleteBtn.title = 'Delete Message';
            deleteBtn.onclick = () => vscode.postMessage({ command: 'requestDeleteMessage', messageId: message.id });

            actions.appendChild(copyBtn);
            actions.appendChild(deleteBtn);

            if (role !== 'system') {
                const editBtn = document.createElement('button');
                editBtn.className = 'msg-action-btn';
                editBtn.innerHTML = '✏️';
                editBtn.title = 'Edit Message';
                editBtn.onclick = () => startEdit(messageDiv, message.id, role);
                actions.insertBefore(editBtn, actions.firstChild);
            }
            
            if (role === 'assistant') {
                const savePromptBtn = document.createElement('button');
                savePromptBtn.className = 'msg-action-btn';
                savePromptBtn.innerHTML = '💾';
                savePromptBtn.title = 'Save as Prompt';
                savePromptBtn.onclick = () => vscode.postMessage({ command: 'saveMessageAsPrompt', content: rawContent });
                actions.appendChild(savePromptBtn);

                const logBtn = document.createElement('button');
                logBtn.className = 'msg-action-btn';
                logBtn.innerHTML = '📜';
                logBtn.title = 'Show Log';
                logBtn.onclick = () => vscode.postMessage({ command: 'requestLog' });
                actions.appendChild(logBtn);
            }

            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(actions);
            
            messageWrapper.appendChild(messageDiv);
            chatMessagesContainer.appendChild(messageWrapper);
            
            enhanceCodeBlocks(messageWrapper);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function updateContext(contextText) {
            contextContainer.innerHTML = '';
            if (contextText && contextText.trim() !== '') {
                contextContainer.innerHTML = `
                    <details class="info-collapsible">
                        <summary>View AI Context</summary>
                        <div class="collapsible-content">
                            <pre>${DOMPurify.sanitize(contextText)}</pre>
                        </div>
                    </details>
                `;
            }
        }
        
        function getStatusIcon(status) {
            switch(status) {
                case 'pending': return '<span class="codicon codicon-circle-large-filled"></span>';
                case 'in_progress': return '<span class="codicon codicon-sync spin"></span>';
                case 'completed': return '<span class="codicon codicon-check"></span>';
                case 'failed': return '<span class="codicon codicon-error"></span>';
                default: return '<span class="codicon codicon-circle-slash"></span>';
            }
        }
        
        function enhanceCodeBlocks(container) {
            container.querySelectorAll('pre').forEach(pre => {
                if (pre.parentElement.tagName === 'DETAILS') return; 

                const codeBlock = pre.querySelector('code');
                if (!codeBlock) return;
        
                const codeContent = codeBlock.innerText;
                let language = [...codeBlock.classList]
                    .find(c => c.startsWith('language-'))
                    ?.replace('language-', '').toLowerCase() || 'text';

                const details = document.createElement('details');
                details.className = 'code-collapsible';
                details.open = true;

                const summary = document.createElement('summary');
                summary.className = 'code-summary';

                const langLabel = document.createElement('span');
                langLabel.className = 'summary-lang-label';
                langLabel.textContent = language.toUpperCase();
                summary.appendChild(langLabel);
                
                const actions = document.createElement('div');
                actions.className = 'code-actions';

                const messageWrapper = pre.closest('.message-wrapper');
                const messageId = messageWrapper ? messageWrapper.dataset.messageId : null;
                const messageDiv = messageWrapper ? messageWrapper.querySelector('.message') : null;

                if (isInspectorEnabled && messageDiv && messageDiv.classList.contains('assistant-message')) {
                    const inspectBtn = document.createElement('button');
                    inspectBtn.className = 'code-action-btn';
                    inspectBtn.innerHTML = '🔍 Inspect';
                    inspectBtn.title = 'Inspect code for bugs and vulnerabilities';
                    inspectBtn.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        vscode.postMessage({
                            command: 'inspectCode',
                            messageId: messageId,
                            code: codeContent,
                            language: language
                        });
                    };
                    actions.appendChild(inspectBtn);
                }

                const executableLanguages = ['bash', 'shell', 'sh', 'powershell', 'pwsh', 'cmd', 'bat', 'batch', 'python'];
                if (executableLanguages.includes(language)) {
                    const executeBtn = document.createElement('button');
                    executeBtn.className = 'code-action-btn';
                    executeBtn.innerHTML = '▶️ Execute';
                    executeBtn.title = 'Execute Script';
                    executeBtn.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        vscode.postMessage({
                            command: 'runScript',
                            code: codeContent,
                            language: language
                        });
                    };
                    actions.appendChild(executeBtn);
                }

                const previousElement = pre.previousElementSibling;
                if (previousElement && previousElement.tagName === 'P') {
                    const text = (previousElement.textContent || '').trim();
                    const fileMatch = text.match(/^File:\s*(.+)$/i);
                    const patchMatch = text.match(/^(Patch|diff):\s*(.+)$/i);
                    let matchInfo = null;
                    if (fileMatch) {
                        matchInfo = { type: 'applyFileContent', path: fileMatch[1].trim(), label: 'Apply to File' };
                    } else if (patchMatch) {
                        matchInfo = { type: 'applyPatchContent', path: patchMatch[2].trim(), label: 'Apply Patch' };
                    }

                    if (matchInfo) {
                        previousElement.style.display = 'none'; // Hide the directive line
                        const applyBtn = document.createElement('button');
                        applyBtn.className = 'code-action-btn apply-btn';
                        applyBtn.innerHTML = '⚙️ ' + matchInfo.label;
                        applyBtn.title = `Write changes to ${matchInfo.path}`;
                        applyBtn.onclick = () => {
                            vscode.postMessage({
                                command: matchInfo.type,
                                filePath: matchInfo.path,
                                content: codeBlock.innerText
                            });
                        };
                        actions.insertBefore(applyBtn, actions.firstChild);
                    }
                } 

                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-action-btn';
                copyBtn.innerHTML = '📋 Copy';
                copyBtn.title = 'Copy Code';
                copyBtn.onclick = async (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    await navigator.clipboard.writeText(codeContent);
                    copyBtn.innerHTML = '✅ Copied!';
                    setTimeout(() => { copyBtn.innerHTML = '📋 Copy'; }, 2000);
                };
                actions.appendChild(copyBtn);

                summary.appendChild(actions);

                pre.parentNode.insertBefore(details, pre);
                details.appendChild(summary);
                details.appendChild(pre);
                
                Prism.highlightElement(codeBlock);
            });
        }


        function setGeneratingState(isGenerating) {
            messageInput.disabled = isGenerating;
            agentModeCheckbox.disabled = isGenerating;
            agentModeToggle.classList.toggle('disabled', isGenerating);
            attachButton.disabled = isGenerating;
            executeButton.disabled = isGenerating;

            sendButton.style.display = isGenerating ? 'none' : 'flex';
            stopButton.style.display = isGenerating ? 'flex' : 'none';
        }

        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText) return;

            setGeneratingState(true);
            
            const messageId = 'user_' + Date.now().toString() + Math.random().toString(36).substring(2);
            const userMessage = { id: messageId, role: 'user', content: messageText };
            
            addChatMessage(userMessage);

            if (agentModeCheckbox.checked) {
                vscode.postMessage({ command: 'runAgent', objective: messageText, message: userMessage });
            } else {
                vscode.postMessage({ command: 'sendMessage', message: userMessage });
            }
            messageInput.value = '';
            messageInput.style.height = 'auto';
        }
        
        attachButton.addEventListener('click', () => {
            fileInput.click();
        });

        executeButton.addEventListener('click', () => {
            setGeneratingState(true);
            vscode.postMessage({ command: 'executeProject' });
        });

        fileInput.addEventListener('change', () => {
            if (!fileInput.files) return;
            for (const file of fileInput.files) {
                const reader = new FileReader();
                const isImage = ['image/png', 'image/jpeg', 'image/bmp', 'image/gif', 'image/webp'].includes(file.type);
                
                reader.onload = (e) => {
                    vscode.postMessage({
                        command: 'loadFile',
                        file: {
                            name: file.name,
                            content: e.target.result,
                            isImage: isImage
                        }
                    });
                };
                
                reader.readAsDataURL(file);
            }
            fileInput.value = '';
        });

        agentModeCheckbox.addEventListener('change', () => {
            vscode.postMessage({ command: 'toggleAgentMode' });
        });

        sendButton.addEventListener('click', sendMessage);
        stopButton.addEventListener('click', () => {
            vscode.postMessage({ command: 'stopGeneration' });
        });

        messageInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
        
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = (messageInput.scrollHeight) + 'px';
        });

        function clearSearch() {
            searchMatches = [];
            currentMatchIndex = -1;
            document.querySelectorAll('mark').forEach(mark => {
                const textNode = document.createTextNode(mark.textContent);
                mark.parentNode.replaceChild(textNode, mark);
            });
            updateSearchCount();
        }

        function performSearch() {
            const query = searchInput.value.trim();
            if (!query) {
                clearSearch();
                return;
            }

            // Remove existing highlights
            document.querySelectorAll('mark').forEach(mark => {
                const textNode = document.createTextNode(mark.textContent);
                mark.parentNode.replaceChild(textNode, mark);
            });

            searchMatches = [];
            const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedQuery})`, 'gi');

            document.querySelectorAll('.message-content').forEach(content => {
                const walker = document.createTreeWalker(
                    content,
                    NodeFilter.SHOW_TEXT,
                    {
                        acceptNode: function(node) {
                            let parent = node.parentElement;
                            while (parent) {
                                if (parent.tagName === 'CODE' || parent.tagName === 'PRE') {
                                    return NodeFilter.FILTER_REJECT;
                                }
                                parent = parent.parentElement;
                            }
                            return NodeFilter.FILTER_ACCEPT;
                        }
                    }
                );

                let node;
                while (node = walker.nextNode()) {
                    const text = node.nodeValue;
                    const fragments = text.split(regex);
                    if (fragments.length > 1) {
                        const fragment = document.createDocumentFragment();
                        for (let i = 0; i < fragments.length; i++) {
                            if (i % 2 === 0) {
                                // Text part
                                fragment.appendChild(document.createTextNode(fragments[i]));
                            } else {
                                // Match part
                                const mark = document.createElement('mark');
                                mark.appendChild(document.createTextNode(fragments[i]));
                                fragment.appendChild(mark);
                                searchMatches.push(mark);
                            }
                        }
                        node.parentNode.replaceChild(fragment, node);
                    }
                }
            });

            currentMatchIndex = -1;
            updateSearchCount();
            if (searchMatches.length > 0) {
                navigateSearch(1);
            }
        }

        function updateSearchCount() {
            if (searchMatches.length === 0) {
                searchResultsCount.textContent = '';
            } else {
                searchResultsCount.textContent = `${currentMatchIndex + 1} of ${searchMatches.length}`;
            }
        }

        function navigateSearch(direction) {
            if (searchMatches.length === 0) return;

            // Remove current highlight
            if (currentMatchIndex >= 0 && searchMatches[currentMatchIndex]) {
                searchMatches[currentMatchIndex].classList.remove('current-match');
            }

            currentMatchIndex += direction;
            if (currentMatchIndex >= searchMatches.length) {
                currentMatchIndex = 0;
            }
            if (currentMatchIndex < 0) {
                currentMatchIndex = searchMatches.length - 1;
            }

            if (searchMatches[currentMatchIndex]) {
                searchMatches[currentMatchIndex].classList.add('current-match');
                searchMatches[currentMatchIndex].scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }

            updateSearchCount();
        }
        
        function displayPlan(plan) {
            const existingPlan = chatMessagesContainer.querySelector('.plan-wrapper');
            if (existingPlan) {
                existingPlan.remove();
            }

            if (!plan) {
                return;
            }
            
            let tasksHtml = plan.tasks.map(task => {
                const resultHtml = task.result ? `
                    <div class="task-result-details">
                        <details ${task.status === 'failed' ? 'open' : ''}>
                            <summary>View Details</summary>
                            <div class="task-result-content">${DOMPurify.sanitize(task.result)}</div>
                        </details>
                    </div>
                ` : '';
                return `
                    <div class="plan-task" data-task-id="${task.id}">
                        <div class="plan-task-header">
                           <div class="task-status">${getStatusIcon(task.status)}</div>
                            <div class="task-description">
                                <strong>${task.id ? task.id + '.' : ''} ${DOMPurify.sanitize(task.description)}</strong>
                            </div>
                        </div>
                        ${resultHtml}
                    </div>`;
            }).join('');
            
            const scratchpadHtml = plan.scratchpad ? `
                <div class="plan-scratchpad">
                    <h3>Agent Scratchpad</h3>
                    ${DOMPurify.sanitize(marked.parse(plan.scratchpad))}
                </div>
            ` : '';
            
            const planWrapper = document.createElement('div');
            planWrapper.className = 'plan-wrapper';
            planWrapper.innerHTML = `
                <details class="plan-container-details" open>
                    <summary class="plan-header">📝 Agent Execution Plan</summary>
                    <div class="plan-body">
                       <div class="plan-objective"><b>Objective:</b> ${DOMPurify.sanitize(plan.objective)}</div>
                       ${tasksHtml}
                       ${scratchpadHtml}
                    </div>
                </details>
            `;
            
            chatMessagesContainer.appendChild(planWrapper);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        document.addEventListener('keydown', e => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'f' || e.key === 'F') {
                    e.preventDefault();
                    searchBar.style.display = 'flex';
                    searchInput.focus();
                    searchInput.select();
                }
            }

            if (searchBar.style.display !== 'none') {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    searchBar.style.display = 'none';
                    clearSearch();
                    messageInput.focus();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    navigateSearch(1);
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateSearch(1);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateSearch(-1);
                }
            }
        });

        searchInput.addEventListener('input', performSearch);
        searchNextBtn.addEventListener('click', () => navigateSearch(1));
        searchPrevBtn.addEventListener('click', () => navigateSearch(-1));
        searchCloseBtn.addEventListener('click', () => {
            searchBar.style.display = 'none';
            clearSearch();
            messageInput.focus();
        });

        window.addEventListener('message', event => {
          const message = event.data;

          switch(message.command) {
            case 'addMessage':
                // The AI has finished, re-enable controls
                setGeneratingState(false);
                addMessage(message.message);
                break;
            case 'setGeneratingState':
                setGeneratingState(message.isGenerating);
                break;
            case 'displayPlan':
                const isFinished = !message.plan || message.plan.tasks.every(t => t.status === 'completed' || t.status === 'failed');
                setGeneratingState(!isFinished);
                displayPlan(message.plan);
                break;

            case 'loadDiscussion':
                attachmentsContainer.innerHTML = '';
                chatMessagesContainer.innerHTML = '';
                const existingPlan = chatMessagesContainer.querySelector('.plan-wrapper');
                if (existingPlan) { existingPlan.remove(); }

                isInspectorEnabled = message.isInspectorEnabled; // Store the inspector status

                let hasChatContent = false;
                if (Array.isArray(message.messages) && message.messages.length > 0) {
                    message.messages.forEach(msg => {
                        addMessage(msg);
                        if ((msg.role === 'user' || msg.role === 'assistant') && (!msg.id || !msg.id.startsWith('attachment_'))) {
                            hasChatContent = true;
                        }
                    });
                }
                
                welcomeMessage.style.display = (attachmentsContainer.hasChildNodes() || hasChatContent) ? 'none' : 'block';
                setGeneratingState(false);
                break;
            case 'resendMessage':
                 setGeneratingState(true);
                 addChatMessage(message.message);
                 vscode.postMessage({ command: 'sendMessage', message: message.message });
                 break;
            case 'updateContext':
                updateContext(message.context);
                break;
            case 'updateTokenProgress':
                const { totalTokens, contextSize } = message;
                if (typeof totalTokens === 'number' && typeof contextSize === 'number' && contextSize > 0) {
                    const percentage = Math.min((totalTokens / contextSize) * 100, 100);
                    tokenProgressBar.style.width = `${percentage}%`;
                    
                    tokenProgressBar.classList.remove('green', 'yellow', 'red');
                    if (percentage > 90) {
                        tokenProgressBar.classList.add('red');
                    } else if (percentage > 75) {
                        tokenProgressBar.classList.add('yellow');
                    } else {
                        tokenProgressBar.classList.add('green');
                    }
                    
                    tokenCountLabel.textContent = `Tokens: ${totalTokens} / ${contextSize}`;
                } else {
                    tokenCountLabel.textContent = `Tokens: N/A`;
                    tokenProgressBar.style.width = '0%';
                }
                break;
            case 'updateAgentMode':
                agentModeCheckbox.checked = message.isActive;
                if (!message.isActive) {
                    setGeneratingState(false);
                }
                break;
            case 'error':
                setGeneratingState(false);
                addChatMessage({ id: 'error_' + Date.now(), role: 'system', content: '❌ Error: ' + message.content });
                break;
            case 'setInputText':
                messageInput.value = message.text;
                messageInput.focus();
                break;
          }
        });
        setGeneratingState(false);
    </script>
</body>
</html>