<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lollms Chat</title>
    <link href="{{codiconsUri}}" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    
    <style>
        :root {
            --code-bg: #1e1e1e;
            --code-border: #3e3e3e;
            --progress-green: #2ecc71;
            --progress-yellow: #f1c40f;
            --progress-red: #e74c3c;
        }
        body { 
            font-family: var(--vscode-font-family); 
            padding: 0;
            margin: 0;
            background-color: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
            overflow: hidden; /* Prevent body scroll */
        }
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .search-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background-color: var(--vscode-editorWidget-background);
            border-bottom: 1px solid var(--vscode-panel-border);
            position: sticky;
            top: -10px; /* Counteract padding */
            margin: -10px -10px 10px -10px;
            z-index: 10;
        }
        #searchInput {
            flex-grow: 1;
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            color: var(--vscode-input-foreground);
            padding: 4px 8px;
            border-radius: 4px;
        }
        #search-results-count {
            font-size: 0.9em;
            color: var(--vscode-description-foreground);
        }
        .search-bar button {
            background: none;
            border: none;
            color: var(--vscode-icon-foreground);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        .search-bar button:hover {
            background-color: var(--vscode-toolbar-hoverBackground);
        }
        mark {
            background-color: var(--vscode-editor-findMatchHighlightBackground);
            color: var(--vscode-editor-foreground);
            border-radius: 2px;
        }
        mark.current-match {
            background-color: var(--vscode-editor-findMatchBackground);
            outline: 1px solid var(--vscode-editor-findMatchBorder);
        }
        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            position: relative;
            width: 95%;
            max-width: 100%;
        }
        .user-message {
            background-color: var(--vscode-inputOption-activeBackground);
            border-left: 4px solid var(--vscode-inputOption-activeBorder);
            align-self: flex-end;

        }
        .assistant-message {
            background-color: var(--vscode-textBlockQuote-background);
            border-left: 4px solid var(--vscode-textBlockQuote-border);
            align-self: flex-start;
        }
        .system-message {
            background-color: var(--vscode-editor-background);
            border: 1px dashed var(--vscode-panel-border);
            font-size: 0.9em;
            opacity: 0.8;
            align-self: center;
            width: 95%;
        }
        .message-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--vscode-textPreformat-foreground);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .message-content {
            line-height: 1.6;
            word-wrap: break-word;
        }

        .code-collapsible, .generation-block {
            background-color: var(--code-bg);
            border: 1px solid var(--code-border);
            border-radius: 8px;
            margin: 12px 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .code-collapsible > pre {
            max-height: 450px;
            overflow-y: auto;
            margin: 0;
            border-top: 1px solid var(--code-border);
        }
        .code-collapsible > pre > code {
            background: transparent !important;
            padding: 16px !important;
            display: block;
            overflow-x: auto;
            font-family: var(--vscode-editor-font-family);
            font-size: 13px;
            line-height: 1.5;
            color: #D4D4D4;
        }
        .code-summary, .generation-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background-color: var(--vscode-editorGroupHeader-tabsBackground);
            color: var(--vscode-tab-activeForeground);
            list-style: none;
        }
        .code-summary {
            cursor: pointer;
        }
        .code-summary::-webkit-details-marker {
            display: none;
        }
        .code-summary::before {
            content: 'â–¼';
            font-size: 0.9em;
            transition: transform 0.2s;
            color: var(--vscode-icon-foreground);
        }
        details[open] > .code-summary::before {
            transform: rotate(-90deg);
        }
        .summary-lang-label {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .code-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        .code-action-btn, .msg-action-btn, .lollms-command-btn, .generation-btn, .remove-attachment-btn {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .code-action-btn:hover, .msg-action-btn:hover, .lollms-command-btn:hover, .generation-btn:hover, .remove-attachment-btn:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }
        .apply-btn, .lollms-command-btn, .generation-btn {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            font-size: 12px;
            padding: 6px 12px;
        }
        .lollms-command-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 8px 0;
        }
        .apply-btn:hover, .lollms-command-btn:hover, .generation-btn:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        .generation-body {
            padding: 16px;
            background-color: var(--vscode-editor-background);
        }
        .generation-body p { margin-top: 0; }
        .generation-btn .codicon-sync.spin { animation: spin 1.5s linear infinite; }
        
        .input-area-wrapper {
            padding: 10px;
            background-color: var(--vscode-panel-background);
            border-top: 1px solid var(--vscode-panel-border);
            position: relative;
        }
        .top-controls {
            display: flex;
            justify-content: space-between; /* Adjusted */
            align-items: center;
            margin-bottom: 8px;
            gap: 15px; /* Added */
        }
        .token-progress {
            flex-grow: 1; /* Added */
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .token-progress-container {
            flex-grow: 1;
            height: 6px;
            background-color: var(--vscode-input-background);
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid var(--vscode-input-border);
        }
        .token-progress-bar {
            height: 100%;
            width: 0%;
            border-radius: 3px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        .token-progress-bar.green { background-color: var(--progress-green); }
        .token-progress-bar.yellow { background-color: var(--progress-yellow); }
        .token-progress-bar.red { background-color: var(--progress-red); }
        #token-count-label {
            font-size: 0.85em;
            color: var(--vscode-descriptionForeground);
            white-space: nowrap;
        }
        #refresh-context-btn {
            background: none;
            border: none;
            color: var(--vscode-icon-foreground);
            cursor: pointer;
            padding: 2px;
        }
        #refresh-context-btn:hover {
            background-color: var(--vscode-toolbar-hoverBackground);
        }
        .input-area {
            display: flex;
            gap: 8px;
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 6px;
            padding: 4px;
            align-items: flex-end;
        }
        .input-area:focus-within {
            border-color: var(--vscode-focusBorder);
        }
        #messageInput {
            flex-grow: 1;
            border: none;
            background-color: transparent;
            color: var(--vscode-input-foreground);
            padding: 8px;
            font-size: 14px;
            font-family: var(--vscode-font-family);
            resize: none;
            line-height: 1.6;
            max-height: 200px;
            outline: none;
        }
        #messageInput:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .control-buttons button {
            background: none;
            border: none;
            color: var(--vscode-icon-foreground);
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 4px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .control-buttons button:hover {
            background-color: var(--vscode-toolbar-hoverBackground);
        }
        .control-buttons button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        #sendButton {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        #sendButton:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        #stopButton {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }
        #stopButton:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }
        .spinner {
            border: 2px solid var(--vscode-panel-border);
            border-top: 2px solid var(--vscode-focusBorder);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-actions {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            gap: 5px;
        }
        .message:hover .message-actions {
            display: flex;
        }
        .msg-action-btn {
            background: var(--vscode-sideBar-background);
            opacity: 0.7;
        }
        .msg-action-btn:hover {
            opacity: 1;
        }
        .agent-mode-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: var(--vscode-descriptionForeground);
            white-space: nowrap; /* Prevent wrapping */
        }
        .agent-mode-toggle.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        .switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--vscode-input-border);
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 12px; width: 12px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--vscode-button-background); }
        input:checked + .slider:before { transform: translateX(14px); }
        
        #more-actions-menu {
            display: none;
            position: absolute;
            bottom: 60px; /* Adjusted for new layout */
            left: 14px;
            background-color: var(--vscode-menu-background);
            border: 1px solid var(--vscode-menu-border);
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 100;
            padding: 5px;
            min-width: 200px;
        }
        .menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 3px;
            color: var(--vscode-menu-foreground);
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            font-size: 13px;
        }
        .menu-item:hover {
            background-color: var(--vscode-menu-selectionBackground);
            color: var(--vscode-menu-selectionForeground);
        }
        .menu-item .codicon {
            font-size: 16px;
        }
        .plan-wrapper {
            width: 95%;
            align-self: center;
            margin-bottom: 15px;
        }
        .plan-container-details {
            border: 1px solid var(--vscode-panel-border);
            border-radius: 8px;
            background-color: var(--vscode-sideBar-background);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* More pleasant shadow */
        }
        .plan-header {
            padding: 12px 16px; /* More padding */
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            list-style: none;
            background-color: var(--vscode-editorGroupHeader-tabsBackground); /* Header background */
            border-bottom: 1px solid var(--vscode-panel-border);
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        details[open] > .plan-header {
            border-bottom: 1px solid var(--vscode-panel-border);
        }
        .plan-header::-webkit-details-marker { display: none; }
        .plan-header::before {
            content: 'â–¶';
            transition: transform 0.2s;
            font-size: 0.8em;
        }
        details[open] > .plan-header::before {
            transform: rotate(90deg);
        }
        .plan-objective {
            font-size: 0.9em;
            font-style: italic; /* Italicize objective */
            color: var(--vscode-descriptionForeground);
            margin-top: 5px;
            padding: 10px 16px;
            background-color: var(--vscode-editor-background); /* Slight background difference */
            border-bottom: 1px solid var(--vscode-panel-border);
        }
        .plan-body {
            padding: 5px 16px 16px 16px;
        }
        .plan-task {
            padding: 12px 0; /* More padding */
            border-bottom: 1px solid var(--vscode-editorWidget-background);
            display: flex; /* Use flexbox for layout */
            gap: 12px;
            align-items: flex-start;
        }
        .plan-task:last-child { border-bottom: none; }
        .task-status {
            font-size: 18px; /* Bigger icons */
            width: 24px;
            text-align: center;
            padding-top: 2px; /* Align icon better with text */
        }
        .task-status .codicon-sync~spin { animation: spin 1.5s linear infinite; }
        .task-status .codicon-check { color: var(--vscode-testing-iconPassed); }
        .task-status .codicon-error { color: var(--vscode-testing-iconFailed); }
        .task-status .codicon-circle-large { 
            color: var(--vscode-descriptionForeground); 
            font-size: 14px;
            vertical-align: middle;
         }
        
        .task-main { flex: 1; }
        .task-description-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-description { font-weight: 500; }
        .retry-btn {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .retry-btn:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }
        .retry-btn .codicon { font-size: 14px; }
        .task-result-details {
            margin-top: 8px;
        }
        .task-result-details summary {
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--vscode-descriptionForeground);
            list-style-position: inside;
        }
        .task-result-content {
            margin-top: 8px;
            background-color: var(--vscode-textCodeBlock-background);
            border-radius: 4px;
            padding: 8px 12px;
            max-height: 200px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: var(--vscode-editor-font-family);
            font-size: 0.9em;
        }
        details.info-collapsible {
            border: 1px solid var(--vscode-panel-border);
            border-radius: 6px;
            background-color: var(--vscode-sideBar-background);
            margin: 0 auto 15px auto;
            width: 95%;
        }
        details.info-collapsible > summary {
            padding: 10px;
            cursor: pointer;
            font-weight: 600;
            list-style: none;
        }
        details.info-collapsible > summary::-webkit-details-marker { display: none; }
        details.info-collapsible > summary::before {
            content: 'â–¶';
            margin-right: 8px;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
        .collapsible-content {
            padding: 0 10px 10px 10px;
            background-color: var(--vscode-editor-background);
            border-top: 1px solid var(--vscode-panel-border);
            max-height: 400px;
            overflow-y: auto;
        }
        .collapsible-content pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: var(--vscode-editor-font-family);
            font-size: 0.9em;
            background-color: var(--vscode-textCodeBlock-background);
            padding: 10px;
            border-radius: 4px;
        }
        .attachment-item-details { /* NEW */
            margin-bottom: 5px;
            border: 1px solid var(--vscode-editorWidget-background);
            border-radius: 6px;
            overflow: hidden;
        }
        .attachment-item-summary { /* NEW */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            background-color: var(--vscode-sideBar-sectionHeaderBackground);
            list-style: none;
        }
        .attachment-item-summary::-webkit-details-marker { display: none; }
        .attachment-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        .attachment-content { /* NEW */
            padding: 10px;
            background-color: var(--vscode-editor-background);
            max-height: 300px;
            overflow: auto;
        }
        .attachment-content img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .attachment-content pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            font-family: var(--vscode-editor-font-family);
        }
        #welcome-message {
            padding: 15px;
            background-color: var(--vscode-textBlockQuote-background);
            border-radius: 6px;
            margin: 0 auto 15px auto;
            font-size: 0.95em;
            width: 95%;
            border-left: 4px solid var(--vscode-focusBorder);
        }
        #welcome-message ul { padding-left: 20px; margin: 10px 0 0 0; }
        #welcome-message li { margin-bottom: 5px; }

        .plan-scratchpad {
            font-size: 0.9em;
            color: var(--vscode-descriptionForeground);
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--vscode-panel-border);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .plan-scratchpad h3 { margin-top: 0; font-size: 1em; font-weight: 600; }
        #chat-messages-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .thinking-collapsible {
            background-color: var(--vscode-editorWidget-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .edit-overlay {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background-color: var(--vscode-editor-background);
        }
        .edit-textarea {
            flex: 1;
            resize: none;
            border: 1px solid var(--vscode-input-border);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            padding: 8px;
            font-family: var(--vscode-font-family);
            font-size: 14px;
            line-height: 1.6;
            outline: none;
            border-radius: 4px;
        }
        .edit-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .edit-save-btn, .edit-cancel-btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        .edit-save-btn {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        .edit-cancel-btn {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }
        .edit-save-btn:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        .edit-cancel-btn:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }        
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="messages" id="messages">
            <div class="search-bar" id="search-bar" style="display: none;">
                <input type="text" id="searchInput" placeholder="Search discussion...">
                <span id="search-results-count"></span>
                <button id="search-prev" title="Previous match"><i class="codicon codicon-arrow-up"></i></button>
                <button id="search-next" title="Next match"><i class="codicon codicon-arrow-down"></i></button>
                <button id="search-close" title="Close search"><i class="codicon codicon-close"></i></button>
            </div>
            
            <div id="context-container"></div>
            
            <details id="attachments-collapsible-wrapper" class="info-collapsible" style="display: none;" open>
                <summary id="attachments-summary">ðŸ“Ž Added Files</summary>
                <div id="attachments-container" class="collapsible-content" style="padding: 5px 0 0 0;">
                </div>
            </details>
            
            <div id="welcome-message" style="display: none;">
                <h3>{{welcomeTitle}}</h3>
                <ul>
                    <li>{{welcomeItem1}}</li>
                    <li>{{welcomeItem2}}</li>
                    <li>{{welcomeItem3}}</li>
                    <li>{{welcomeItem4}}</li>
                </ul>
            </div>

            <div id="chat-messages-container"></div>

        </div>

        <div class="input-area-wrapper">
            <div id="more-actions-menu">
                <button class="menu-item" id="attachButton"><i class="codicon codicon-add"></i><span>Attach Files</span></button>
                <button class="menu-item" id="setEntryPointButton"><i class="codicon codicon-target"></i><span>Set Project Entry Point</span></button>
                <button class="menu-item" id="executeButton"><i class="codicon codicon-play"></i><span>Execute Project</span></button>
            </div>

            <div class="top-controls">
                <div class="token-progress">
                    <div class="token-progress-container">
                        <div class="token-progress-bar" id="token-progress-bar"></div>
                    </div>
                    <div id="context-status-container" style="display: flex; align-items: center; gap: 8px;">
                        <span id="token-count-label">Tokens: 0 / 0</span>
                        <button id="refresh-context-btn" title="{{tooltipRefreshContext}}"><i class="codicon codicon-sync"></i></button>
                    </div>
                    <div id="context-loading-spinner" style="display: none; align-items: center; gap: 8px; font-size: 0.9em; color: var(--vscode-descriptionForeground);">
                        <div class="spinner"></div>
                        <span>{{progressLoadingFiles}}</span>
                    </div>
                </div>
                <div class="agent-mode-toggle">
                    <span>ðŸ¤– Agent Mode</span>
                    <label class="switch">
                        <input type="checkbox" id="agentModeCheckbox">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="input-area">
                <div class="control-buttons">
                    <button id="moreActionsButton" title="More Actions"><i class="codicon codicon-ellipsis"></i></button>
                </div>
                <textarea id="messageInput" placeholder="Enter your message (Shift+Enter for new line)..." rows="1"></textarea>
                <div class="control-buttons">
                    <button id="sendButton" title="Send Message"><i class="codicon codicon-send"></i></button>
                    <button id="stopButton" title="Stop Generation" style="display: none;">
                        <div class="spinner"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none;" multiple accept=".md,.txt,.msg,.docx,.pdf,.pptx,.xlsx,.csv,.png,.jpg,.jpeg,.bmp,.webp">

    <script src="https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>


    <script>
        const vscode = acquireVsCodeApi();
        const messagesDiv = document.getElementById('messages');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const stopButton = document.getElementById('stopButton');
        const moreActionsButton = document.getElementById('moreActionsButton');
        const moreActionsMenu = document.getElementById('more-actions-menu');
        const attachButton = document.getElementById('attachButton');
        const executeButton = document.getElementById('executeButton');
        const setEntryPointButton = document.getElementById('setEntryPointButton');
        const fileInput = document.getElementById('fileInput');
        const agentModeCheckbox = document.getElementById('agentModeCheckbox');
        const agentModeToggle = document.querySelector('.agent-mode-toggle');
        const contextContainer = document.getElementById('context-container');
        const attachmentsContainer = document.getElementById('attachments-container');
        const welcomeMessage = document.getElementById('welcome-message');
        
        const tokenProgressBar = document.getElementById('token-progress-bar');
        const tokenCountLabel = document.getElementById('token-count-label');
        const refreshContextBtn = document.getElementById('refresh-context-btn');
        const contextStatusContainer = document.getElementById('context-status-container');
        const contextLoadingSpinner = document.getElementById('context-loading-spinner');

        const searchBar = document.getElementById('search-bar');
        const searchInput = document.getElementById('searchInput');
        const searchResultsCount = document.getElementById('search-results-count');
        const searchPrevBtn = document.getElementById('search-prev');
        const searchNextBtn = document.getElementById('search-next');
        const searchCloseBtn = document.getElementById('search-close');

        let searchMatches = [];
        let currentMatchIndex = -1;
        let isInspectorEnabled = false;


        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false
        });
        
        function processThinkTags(content) {
            const thoughts = [];
            const thinkRegex = /<(think|thinking)>([\s\S]*?)<\/\1>/g;
            const processedContent = content.replace(thinkRegex, (match, tag, thoughtContent) => {
                thoughts.push(thoughtContent);
                return ''; // Remove the block from the main content
            });
            return { thoughts, processedContent: processedContent.trim() };
        }

        function startEdit(messageDiv, messageId, role) {
            const contentDiv = messageDiv.querySelector('.message-content');
            const originalContentJSON = messageDiv.dataset.originalContent;
            const originalContent = JSON.parse(originalContentJSON);

            const editOverlay = document.createElement('div');
            editOverlay.className = 'edit-overlay';
            editOverlay.innerHTML = `
                <textarea class="edit-textarea">${originalContent}</textarea>
                <div class="edit-buttons">
                    <button class="edit-cancel-btn">Cancel</button>
                    <button class="edit-save-btn">Save</button>
                </div>
            `;
            contentDiv.style.display = 'none';
            messageDiv.appendChild(editOverlay);
            const textarea = editOverlay.querySelector('.edit-textarea');
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            });
            setTimeout(() => { // ensure it's rendered to calc scrollHeight
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            }, 0);
            const saveBtn = editOverlay.querySelector('.edit-save-btn');
            const cancelBtn = editOverlay.querySelector('.edit-cancel-btn');
            saveBtn.onclick = () => saveEdit(messageDiv, contentDiv, editOverlay, textarea.value, messageId, role);
            cancelBtn.onclick = () => {
                editOverlay.remove();
                contentDiv.style.display = 'block';
            };
            textarea.focus();
        }

        function saveEdit(messageDiv, contentDiv, editOverlay, newContent, messageId, role) {
            // Remove existing thoughts
            messageDiv.querySelectorAll('.thinking-collapsible').forEach(el => el.remove());
            let processedContent = newContent;
            let thoughts = [];
            if (role === 'assistant') {
                const res = processThinkTags(newContent);
                thoughts = res.thoughts;
                processedContent = res.processedContent;
            }
            if (thoughts.length > 0) {
                thoughts.forEach(thought => {
                    const details = document.createElement('details');
                    details.className = 'info-collapsible thinking-collapsible';
                    details.innerHTML = `
                        <summary>ðŸ¤” Thinking Process</summary>
                        <div class="collapsible-content">${DOMPurify.sanitize(marked.parse(thought))}</div>
                    `;
                    messageDiv.insertBefore(details, contentDiv);
                });
            }
            contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(processedContent));
            enhanceCodeBlocks(messageDiv.parentElement);
            messageDiv.dataset.originalContent = JSON.stringify(newContent);
            editOverlay.remove();
            contentDiv.style.display = 'block';
            vscode.postMessage({ command: 'updateMessage', messageId, newContent });
        }
        
        function addMessage(message) {
            if (message.id && message.id.startsWith('attachment_')) {
                addAttachment(message);
            } else {
                addChatMessage(message);
            }
        }

        function addAttachment(message) {
            const wrapper = document.getElementById('attachments-collapsible-wrapper');
            const attachmentsContainer = document.getElementById('attachments-container');
            const summary = document.getElementById('attachments-summary');
        
            if (document.querySelector(`.attachment-item-details[data-message-id='${message.id}']`)) return;
            
            wrapper.style.display = 'block';
        
            let fileName = 'file';
            let fileIcon = 'codicon-file-text';
            let contentHtml = '';

            if (Array.isArray(message.content)) { // Image attachment
                const textPart = message.content.find(p => p.type === 'text');
                const imagePart = message.content.find(p => p.type === 'image_url');
                if (imagePart) {
                    fileName = textPart?.text.replace('Attached image: ', '') || 'image.png';
                    fileIcon = 'codicon-file-media';
                    contentHtml = `<img src="${imagePart.image_url.url}" alt="${fileName}">`;
                }
            } else if (typeof message.content === 'string') { // Text file attachment
                const nameMatch = message.content.match(/\*\*([^*]+)\*\*/);
                const codeMatch = message.content.match(/```(?:\w*)\n([\s\S]+?)\n```/);
                if (nameMatch) fileName = nameMatch[1];
                if (codeMatch) contentHtml = `<pre>${DOMPurify.sanitize(codeMatch[1])}</pre>`;
            }

            const details = document.createElement('details');
            details.className = 'attachment-item-details';
            details.dataset.messageId = message.id;

            const summaryEl = document.createElement('summary');
            summaryEl.className = 'attachment-item-summary';
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'attachment-info';
            infoDiv.innerHTML = `<span class="codicon ${fileIcon}"></span> <span>${fileName}</span>`;

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-attachment-btn';
            removeBtn.innerHTML = '<i class="codicon codicon-trash"></i>';
            removeBtn.title = 'Remove Attachment';
            removeBtn.onclick = (e) => {
                e.preventDefault(); // Prevent details toggling
                e.stopPropagation();
                vscode.postMessage({ command: 'requestDeleteMessage', messageId: message.id });
            };
            
            summaryEl.appendChild(infoDiv);
            summaryEl.appendChild(removeBtn);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'attachment-content';
            contentDiv.innerHTML = contentHtml;
            
            details.appendChild(summaryEl);
            details.appendChild(contentDiv);
            attachmentsContainer.appendChild(details);
            
            const count = attachmentsContainer.children.length;
            summary.innerHTML = `ðŸ“Ž Added Files (${count})`;
        }


        function addChatMessage(message) {
            const role = message.role;
            const rawContent = message.content;
            
            let textForClipboard = '';
            let contentForDisplay = '';
            let isMultipart = false;

            if (typeof rawContent === 'string') {
                contentForDisplay = rawContent;
                textForClipboard = rawContent;
            } else if (Array.isArray(rawContent)) {
                isMultipart = true;
                let textParts = [];
                rawContent.forEach(part => {
                    if (part.type === 'text') {
                        textParts.push(part.text);
                    } else if (part.type === 'image_url') {
                        contentForDisplay += `<img src="${part.image_url.url}" style="max-width: 90%; max-height: 400px; border-radius: 4px; margin-top: 5px; display: block;">`;
                    }
                });
                const combinedText = textParts.join('\n');
                contentForDisplay = combinedText + '\n' + contentForDisplay;
                textForClipboard = combinedText;
            }

            let { thoughts, processedContent } = processThinkTags(contentForDisplay);
            
            const existingMsgWrapper = chatMessagesContainer.querySelector(`.message-wrapper[data-message-id='${message.id}']`);
            if (existingMsgWrapper) {
                const messageDiv = existingMsgWrapper.querySelector('.message');
                const contentDiv = messageDiv.querySelector('.message-content');
                messageDiv.querySelectorAll('.thinking-collapsible').forEach(el => el.remove());
                
                let updateResult = processThinkTags(rawContent);
                thoughts = updateResult.thoughts;
                processedContent = updateResult.processedContent;

                thoughts.forEach(thought => {
                    const details = document.createElement('details');
                    details.className = 'info-collapsible thinking-collapsible';
                    details.innerHTML = `<summary>ðŸ¤” Thinking Process</summary><div class="collapsible-content">${DOMPurify.sanitize(marked.parse(thought))}</div>`;
                    messageDiv.insertBefore(details, contentDiv);
                });
                contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(processedContent));
                messageDiv.dataset.originalContent = JSON.stringify(rawContent);
                enhanceCodeBlocks(existingMsgWrapper);
                return;
            }

            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper';
            messageWrapper.dataset.messageId = message.id;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            messageDiv.dataset.originalContent = JSON.stringify(rawContent);
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            headerDiv.textContent = role;
            messageDiv.appendChild(headerDiv);

            thoughts.forEach(thought => {
                const details = document.createElement('details');
                details.className = 'info-collapsible thinking-collapsible';
                details.innerHTML = `<summary>ðŸ¤” Thinking Process</summary><div class="collapsible-content">${DOMPurify.sanitize(marked.parse(thought))}</div>`;
                messageDiv.appendChild(details);
            });

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.id = `content-${message.id}`;
            contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(processedContent));
            
            const actions = document.createElement('div');
            actions.className = 'message-actions';

            if (role !== 'system' && !isMultipart) {
                const editBtn = document.createElement('button');
                editBtn.className = 'msg-action-btn';
                editBtn.innerHTML = 'âœï¸';
                editBtn.title = 'Edit Message';
                editBtn.onclick = () => startEdit(messageDiv, message.id, role);
                actions.appendChild(editBtn);

                if (role === 'user') {
                    const resendBtn = document.createElement('button');
                    resendBtn.className = 'msg-action-btn';
                    resendBtn.innerHTML = 'ðŸ”„';
                    resendBtn.title = 'Regenerate response';
                    resendBtn.onclick = () => vscode.postMessage({ command: 'regenerateFromMessage', messageId: message.id });
                    actions.appendChild(resendBtn);
                }
            }

            const copyBtn = document.createElement('button');
            copyBtn.className = 'msg-action-btn';
            copyBtn.innerHTML = 'ðŸ“‹';
            copyBtn.title = 'Copy Message';
            copyBtn.onclick = () => {
                vscode.postMessage({ command: 'copyToClipboard', text: textForClipboard });
                copyBtn.innerHTML = 'âœ…';
                setTimeout(() => { copyBtn.innerHTML = 'ðŸ“‹'; }, 2000);
            };
            actions.appendChild(copyBtn);

            if (role === 'assistant') {
                const savePromptBtn = document.createElement('button');
                savePromptBtn.className = 'msg-action-btn';
                savePromptBtn.innerHTML = 'ðŸ’¾';
                savePromptBtn.title = 'Save as Prompt';
                savePromptBtn.onclick = () => vscode.postMessage({ command: 'saveMessageAsPrompt', content: textForClipboard });
                actions.appendChild(savePromptBtn);

                const logBtn = document.createElement('button');
                logBtn.className = 'msg-action-btn';
                logBtn.innerHTML = 'ðŸ“œ';
                logBtn.title = 'Show Log';
                logBtn.onclick = () => vscode.postMessage({ command: 'requestLog' });
                actions.appendChild(logBtn);
            }

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'msg-action-btn';
            deleteBtn.innerHTML = 'ðŸ—‘ï¸';
            deleteBtn.title = 'Delete Message';
            deleteBtn.onclick = () => vscode.postMessage({ command: 'requestDeleteMessage', messageId: message.id });
            actions.appendChild(deleteBtn);

            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(actions);
            
            messageWrapper.appendChild(messageDiv);
            chatMessagesContainer.appendChild(messageWrapper);
            
            enhanceCodeBlocks(messageWrapper);
            enhanceWithCommandButtons(messageWrapper);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function updateContext(contextText) {
            contextContainer.innerHTML = '';
            if (contextText && contextText.trim() !== '') {
                contextContainer.innerHTML = `
                    <details class="info-collapsible">
                        <summary>Project Context</summary>
                        <div class="collapsible-content">
                            <pre>${DOMPurify.sanitize(contextText)}</pre>
                        </div>
                    </details>
                `;
            }
        }
        
        function getStatusIcon(status) {
            switch(status) {
                case 'pending': return '<span class="codicon codicon-circle-large"></span>';
                case 'in_progress': return '<span class="codicon codicon-sync spin"></span>';
                case 'completed': return '<span class="codicon codicon-check"></span>';
                case 'failed': return '<span class="codicon codicon-error"></span>';
                default: return '<span class="codicon codicon-circle-slash"></span>';
            }
        }
        
        function enhanceWithCommandButtons(container) {
            const contentDivs = container.querySelectorAll('.message-content');
            const commandRegex = /\[command:(\w+)\]({.*})/g;

            contentDivs.forEach(contentDiv => {
                contentDiv.innerHTML = contentDiv.innerHTML.replace(commandRegex, (match, command, paramsJson) => {
                    try {
                        const params = JSON.parse(paramsJson);
                        let buttonText = command;
                        let icon = 'zap'; // Default icon

                        if (command === 'createNotebook') {
                            buttonText = `Create Notebook: ${params.path || 'new_notebook.ipynb'}`;
                            icon = 'new-file';
                        } else if (command === 'gitCommit') {
                            buttonText = `Prepare Commit: "${params.message.substring(0, 30)}..."`;
                            icon = 'git-commit';
                        }
                        
                        return `<p><button class="lollms-command-btn" 
                                    data-command='${command}' 
                                    data-params='${paramsJson}'>
                                    <i class="codicon codicon-${icon}"></i> ${buttonText}
                                </button></p>`;
                    } catch (e) {
                        console.error("Failed to parse command JSON:", e);
                        return match;
                    }
                });
            });
        }
        function enhanceCodeBlocks(container) {
            container.querySelectorAll('pre:not([data-enhanced])').forEach(pre => {
                const codeBlock = pre.querySelector('code');
                if (!codeBlock) return;
        
                let language = [...codeBlock.classList]
                    .find(c => c.startsWith('language-'))
                    ?.replace('language-', '').toLowerCase() || 'text';
                
                if (language === 'image_prompt') {
                    const previousElement = pre.previousElementSibling;
                    const fileMatch = previousElement && previousElement.tagName === 'P' ? (previousElement.textContent || '').match(/^File:\s*(.+)$/i) : null;
                    if (fileMatch) {
                        previousElement.style.display = 'none';
                        const filePath = fileMatch[1].trim();
                        const imagePrompt = codeBlock.innerText;

                        const generationBlock = document.createElement('div');
                        generationBlock.className = 'generation-block';
                        generationBlock.innerHTML = `
                            <div class="generation-header">
                                <span class="codicon codicon-device-camera"></span>
                                <span>Generate Image: <strong>${filePath}</strong></span>
                            </div>
                            <div class="generation-body">
                                <p>${DOMPurify.sanitize(imagePrompt)}</p>
                                <button class="generation-btn" data-prompt="${imagePrompt}" data-filepath="${filePath}">
                                    <span class="codicon codicon-sparkle"></span> Generate
                                </button>
                            </div>
                        `;
                        pre.replaceWith(generationBlock);
                        pre.dataset.enhanced = "true";
                    }
                    return; 
                }

                if (pre.parentElement.tagName === 'DETAILS' && !pre.parentElement.classList.contains('code-collapsible')) return;

                const details = document.createElement('details');
                details.className = 'code-collapsible';
                details.open = true;

                const summary = document.createElement('summary');
                summary.className = 'code-summary';

                const langLabel = document.createElement('span');
                langLabel.className = 'summary-lang-label';
                langLabel.textContent = language.toUpperCase();
                summary.appendChild(langLabel);
                
                const actions = document.createElement('div');
                actions.className = 'code-actions';

                const previousElement = pre.previousElementSibling;
                if (previousElement && previousElement.tagName === 'P') {
                    const text = (previousElement.textContent || '').trim();
                    const fileMatch = text.match(/^File:\s*(.+)$/i);
                    const patchMatch = text.match(/^(Patch|diff):\s*(.+)$/i);
                    let matchInfo = null;

                    if (fileMatch) {
                        matchInfo = { type: 'applyFileContent', path: fileMatch[1].trim(), label: 'Apply to File' };
                    } else if (patchMatch) {
                        matchInfo = { type: 'applyPatchContent', path: patchMatch[2].trim(), label: 'Apply Patch' };
                    }

                    if (matchInfo) {
                        previousElement.style.display = 'none';
                        const applyBtn = document.createElement('button');
                        applyBtn.className = 'code-action-btn apply-btn';
                        applyBtn.innerHTML = 'âš™ï¸ ' + matchInfo.label;
                        applyBtn.title = `Write changes to ${matchInfo.path}`;
                        applyBtn.dataset.action = matchInfo.type;
                        applyBtn.dataset.filePath = matchInfo.path;
                        actions.appendChild(applyBtn);
                    }
                }

                const messageWrapper = pre.closest('.message-wrapper');
                const messageDiv = messageWrapper ? messageWrapper.querySelector('.message') : null;

                if (isInspectorEnabled && messageDiv && messageDiv.classList.contains('assistant-message')) {
                    const inspectBtn = document.createElement('button');
                    inspectBtn.className = 'code-action-btn';
                    inspectBtn.innerHTML = 'ðŸ” Inspect';
                    inspectBtn.title = 'Inspect code for bugs and vulnerabilities';
                    inspectBtn.dataset.action = 'inspectCode';
                    actions.appendChild(inspectBtn);
                }

                const executableLanguages = ['bash', 'shell', 'sh', 'powershell', 'pwsh', 'cmd', 'bat', 'batch', 'python', 'py'];
                if (executableLanguages.includes(language)) {
                    const executeBtn = document.createElement('button');
                    executeBtn.className = 'code-action-btn';
                    executeBtn.innerHTML = 'â–¶ï¸ Execute';
                    executeBtn.title = 'Execute Script';
                    executeBtn.dataset.action = 'runScript';
                    executeBtn.dataset.language = language;
                    actions.appendChild(executeBtn);
                }

                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-action-btn';
                copyBtn.innerHTML = 'ðŸ“‹ Copy';
                copyBtn.title = 'Copy Code';
                copyBtn.dataset.action = 'copyCode';
                actions.appendChild(copyBtn);

                summary.appendChild(actions);

                pre.parentNode.insertBefore(details, pre);
                details.appendChild(summary);
                details.appendChild(pre);
                pre.dataset.enhanced = "true";
                
                Prism.highlightElement(codeBlock);
            });
        }
        
        function setGeneratingState(isGenerating) {
            messageInput.disabled = isGenerating;
            agentModeCheckbox.disabled = isGenerating;
            agentModeToggle.classList.toggle('disabled', isGenerating);
            attachButton.disabled = isGenerating;
            executeButton.disabled = isGenerating;
            setEntryPointButton.disabled = isGenerating;

            sendButton.style.display = isGenerating ? 'none' : 'flex';
            stopButton.style.display = isGenerating ? 'flex' : 'none';
        }

        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText) return;

            setGeneratingState(true);
            
            const messageId = 'user_' + Date.now().toString() + Math.random().toString(36).substring(2);
            const userMessage = { id: messageId, role: 'user', content: messageText };
            
            addChatMessage(userMessage);

            if (agentModeCheckbox.checked) {
                vscode.postMessage({ command: 'runAgent', objective: messageText, message: userMessage });
            } else {
                vscode.postMessage({ command: 'sendMessage', message: userMessage });
            }
            messageInput.value = '';
            messageInput.style.height = 'auto';
        }
        
        attachButton.addEventListener('click', () => {
            fileInput.click();
        });

        executeButton.addEventListener('click', () => {
            setGeneratingState(true);
            vscode.postMessage({ command: 'executeProject' });
        });
        
        setEntryPointButton.addEventListener('click', () => {
            vscode.postMessage({ command: 'setEntryPoint' });
        });

        fileInput.addEventListener('change', () => {
            if (!fileInput.files) return;
            for (const file of fileInput.files) {
                const reader = new FileReader();
                const isImage = ['image/png', 'image/jpeg', 'image/bmp', 'image/gif', 'image/webp'].includes(file.type);
                
                reader.onload = (e) => {
                    vscode.postMessage({
                        command: 'loadFile',
                        file: {
                            name: file.name,
                            content: e.target.result,
                            isImage: isImage
                        }
                    });
                };
                
                reader.readAsDataURL(file);
            }
            fileInput.value = '';
        });

        agentModeCheckbox.addEventListener('change', () => {
            vscode.postMessage({ command: 'toggleAgentMode' });
        });

        refreshContextBtn.addEventListener('click', () => {
            vscode.postMessage({ command: 'calculateTokens' });
            contextStatusContainer.style.display = 'none';
            contextLoadingSpinner.style.display = 'flex';
        });

        sendButton.addEventListener('click', sendMessage);
        stopButton.addEventListener('click', () => {
            vscode.postMessage({ command: 'stopGeneration' });
        });

        messageInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
        
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = (messageInput.scrollHeight) + 'px';
        });

        function clearSearch() {
            searchMatches = [];
            currentMatchIndex = -1;
            document.querySelectorAll('mark').forEach(mark => {
                const textNode = document.createTextNode(mark.textContent);
                mark.parentNode.replaceChild(textNode, mark);
            });
            updateSearchCount();
        }

        function performSearch() {
            const query = searchInput.value.trim();
            if (!query) {
                clearSearch();
                return;
            }

            // Remove existing highlights
            document.querySelectorAll('mark').forEach(mark => {
                const textNode = document.createTextNode(mark.textContent);
                mark.parentNode.replaceChild(textNode, mark);
            });

            searchMatches = [];
            const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedQuery})`, 'gi');

            document.querySelectorAll('.message-content').forEach(content => {
                const walker = document.createTreeWalker(
                    content,
                    NodeFilter.SHOW_TEXT,
                    {
                        acceptNode: function(node) {
                            let parent = node.parentElement;
                            while (parent) {
                                if (parent.tagName === 'CODE' || parent.tagName === 'PRE') {
                                    return NodeFilter.FILTER_REJECT;
                                }
                                parent = parent.parentElement;
                            }
                            return NodeFilter.FILTER_ACCEPT;
                        }
                    }
                );

                let node;
                while (node = walker.nextNode()) {
                    const text = node.nodeValue;
                    const fragments = text.split(regex);
                    if (fragments.length > 1) {
                        const fragment = document.createDocumentFragment();
                        for (let i = 0; i < fragments.length; i++) {
                            if (i % 2 === 0) {
                                // Text part
                                fragment.appendChild(document.createTextNode(fragments[i]));
                            } else {
                                // Match part
                                const mark = document.createElement('mark');
                                mark.appendChild(document.createTextNode(fragments[i]));
                                fragment.appendChild(mark);
                                searchMatches.push(mark);
                            }
                        }
                        node.parentNode.replaceChild(fragment, node);
                    }
                }
            });

            currentMatchIndex = -1;
            updateSearchCount();
            if (searchMatches.length > 0) {
                navigateSearch(1);
            }
        }

        function updateSearchCount() {
            if (searchMatches.length === 0) {
                searchResultsCount.textContent = '';
            } else {
                searchResultsCount.textContent = `${currentMatchIndex + 1} of ${searchMatches.length}`;
            }
        }

        function navigateSearch(direction) {
            if (searchMatches.length === 0) return;

            // Remove current highlight
            if (currentMatchIndex >= 0 && searchMatches[currentMatchIndex]) {
                searchMatches[currentMatchIndex].classList.remove('current-match');
            }

            currentMatchIndex += direction;
            if (currentMatchIndex >= searchMatches.length) {
                currentMatchIndex = 0;
            }
            if (currentMatchIndex < 0) {
                currentMatchIndex = searchMatches.length - 1;
            }

            if (searchMatches[currentMatchIndex]) {
                searchMatches[currentMatchIndex].classList.add('current-match');
                searchMatches[currentMatchIndex].scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }

            updateSearchCount();
        }        
        function displayPlan(plan) {
            const existingPlan = chatMessagesContainer.querySelector('.plan-wrapper');
            if (existingPlan) {
                existingPlan.remove();
            }

            if (!plan) return;

            if (plan.tasks.length === 0) {
                 const planWrapper = document.createElement('div');
                planWrapper.className = 'plan-wrapper';
                planWrapper.innerHTML = `
                    <details class="plan-container-details" open>
                        <summary class="plan-header"><span class="codicon codicon-sync spin"></span> Agent Execution Plan</summary>
                        <div class="plan-body">
                           <div class="plan-objective"><b>Objective:</b> ${DOMPurify.sanitize(plan.objective)}</div>
                           <div class="plan-scratchpad">
                                <h3>Agent Status</h3>
                                ${DOMPurify.sanitize(marked.parse(plan.scratchpad))}
                           </div>
                        </div>
                    </details>
                `;
                chatMessagesContainer.appendChild(planWrapper);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                return;
            }
            
            let tasksHtml = plan.tasks.map(task => {
                const resultHtml = task.result ? `
                    <div class="task-result-details">
                        <details ${task.status === 'failed' ? 'open' : ''}>
                            <summary>View Details</summary>
                            <div class="task-result-content">${DOMPurify.sanitize(task.result)}</div>
                        </details>
                    </div>
                ` : '';

                let retryButtonHtml = '';
                if (task.status === 'failed' && task.can_retry) {
                    retryButtonHtml = `<button class="retry-btn" data-task-id="${task.id}" title="Retry this task"><span class="codicon codicon-debug-restart"></span>Retry</button>`;
                } else if (task.status === 'failed' && !task.can_retry) {
                     retryButtonHtml = `<span style="font-size:0.9em; opacity:0.7;">(Retries exhausted)</span>`;
                }

                return `
                    <div class="plan-task" data-task-id="${task.id}">
                        <div class="task-status">${getStatusIcon(task.status)}</div>
                        <div class="task-main">
                            <div class="task-description-wrapper">
                                <div class="task-description">
                                    <strong>${task.id}. ${DOMPurify.sanitize(task.description)}</strong>
                                </div>
                                ${retryButtonHtml}
                            </div>
                            ${resultHtml}
                        </div>
                    </div>`;
            }).join('');
            
            const scratchpadHtml = plan.scratchpad ? `
                <div class="plan-scratchpad">
                    <h3>Agent Scratchpad</h3>
                    ${DOMPurify.sanitize(marked.parse(plan.scratchpad))}
                </div>
            ` : '';
            
            const planWrapper = document.createElement('div');
            planWrapper.className = 'plan-wrapper';
            planWrapper.innerHTML = `
                <details class="plan-container-details" open>
                    <summary class="plan-header">ðŸ“ Agent Execution Plan</summary>
                    <div class="plan-body">
                       <div class="plan-objective"><b>Objective:</b> ${DOMPurify.sanitize(plan.objective)}</div>
                       <div id="plan-tasks-container">${tasksHtml}</div>
                       ${scratchpadHtml}
                    </div>
                </details>
            `;
            
            chatMessagesContainer.appendChild(planWrapper);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        chatMessagesContainer.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            
            if (target.classList.contains('retry-btn')) {
                vscode.postMessage({
                    command: 'retryAgentTask',
                    taskId: target.dataset.taskId
                });
                target.disabled = true;
                target.innerHTML = `<span class="codicon codicon-sync spin"></span> Retrying...`;
                return;
            }
            
            const codeCollapsible = target.closest('.code-collapsible');
            const codeBlock = codeCollapsible ? codeCollapsible.querySelector('code') : null;
            const codeContent = codeBlock ? codeBlock.innerText : null;
            const messageWrapper = target.closest('.message-wrapper');
            const messageId = messageWrapper ? messageWrapper.dataset.messageId : null;

            const action = target.dataset.action;

            if (action === 'copyCode' && codeContent) {
                vscode.postMessage({ command: 'copyToClipboard', text: codeContent });
                target.innerHTML = 'âœ… Copied!';
                setTimeout(() => { target.innerHTML = 'ðŸ“‹ Copy'; }, 2000);
            } else if (action === 'runScript' && codeContent) {
                vscode.postMessage({
                    command: 'runScript',
                    code: codeContent,
                    language: target.dataset.language
                });
            } else if (action === 'inspectCode' && codeContent) {
                vscode.postMessage({
                    command: 'inspectCode',
                    messageId: messageId,
                    code: codeContent,
                    language: codeBlock.className.replace('language-', '').toLowerCase()
                });
            } else if ((action === 'applyFileContent' || action === 'applyPatchContent') && codeContent) {
                vscode.postMessage({
                    command: action,
                    filePath: target.dataset.filePath,
                    content: codeContent
                });
            } else if(target.classList.contains('lollms-command-btn')) {
                 const command = target.dataset.command;
                 const params = JSON.parse(target.dataset.params);
                 vscode.postMessage({ 
                     command: 'executeLollmsCommand', 
                     details: { command, params }
                 });
            }

            if (target.classList.contains('generation-btn')) {
                const prompt = target.dataset.prompt;
                const filepath = target.dataset.filepath;
                target.disabled = true;
                target.innerHTML = `<span class="codicon codicon-sync spin"></span> Generating...`;
                vscode.postMessage({
                    command: 'generateImage',
                    prompt: prompt,
                    filePath: filepath,
                    buttonId: target.id || (target.id = `gen-${Date.now()}`) 
                });
            }
        });
        

        document.addEventListener('keydown', e => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'f' || e.key === 'F') {
                    e.preventDefault();
                    searchBar.style.display = 'flex';
                    searchInput.focus();
                    searchInput.select();
                }
            }

            if (searchBar.style.display !== 'none') {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    searchBar.style.display = 'none';
                    clearSearch();
                    messageInput.focus();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    navigateSearch(1);
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateSearch(1);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateSearch(-1);
                }
            }
        });

        searchInput.addEventListener('input', performSearch);
        searchNextBtn.addEventListener('click', () => navigateSearch(1));
        searchPrevBtn.addEventListener('click', () => navigateSearch(-1));
        searchCloseBtn.addEventListener('click', () => {
            searchBar.style.display = 'none';
            clearSearch();
            messageInput.focus();
        });
        window.addEventListener('message', event => {
            const message = event.data;
            switch(message.command) {
                case 'addMessage':
                    addChatMessage(message.message);
                    break;
                case 'appendMessageChunk':
                    {
                        const wrapper = document.querySelector(`.message-wrapper[data-message-id='${message.id}']`);
                        if(wrapper) {
                            const contentDiv = wrapper.querySelector('.message-content');
                            const messageDiv = wrapper.querySelector('.message');
                            if (contentDiv && messageDiv) {
                                let originalContent = JSON.parse(messageDiv.dataset.originalContent);
                                originalContent += message.chunk;
                                messageDiv.dataset.originalContent = JSON.stringify(originalContent);
                                
                                const { thoughts, processedContent } = processThinkTags(originalContent);

                                messageDiv.querySelectorAll('.thinking-collapsible').forEach(el => el.remove());
                                thoughts.forEach(thought => {
                                    const details = document.createElement('details');
                                    details.className = 'info-collapsible thinking-collapsible';
                                    details.innerHTML = `<summary>ðŸ¤” Thinking Process</summary><div class="collapsible-content">${DOMPurify.sanitize(marked.parse(thought))}</div>`;
                                    messageDiv.insertBefore(details, contentDiv);
                                });

                                contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(processedContent));
                                enhanceCodeBlocks(wrapper);
                                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                            }
                        }
                    }
                    break;
                case 'finalizeMessage':
                    {
                        const wrapper = document.querySelector(`.message-wrapper[data-message-id='${message.id}']`);
                        if(wrapper) {
                            const contentDiv = wrapper.querySelector('.message-content');
                            const messageDiv = wrapper.querySelector('.message');
                            if (contentDiv && messageDiv) {
                                messageDiv.dataset.originalContent = JSON.stringify(message.fullContent);
                                const { thoughts, processedContent } = processThinkTags(message.fullContent);

                                messageDiv.querySelectorAll('.thinking-collapsible').forEach(el => el.remove());
                                thoughts.forEach(thought => {
                                    const details = document.createElement('details');
                                    details.className = 'info-collapsible thinking-collapsible';
                                    details.innerHTML = `<summary>ðŸ¤” Thinking Process</summary><div class="collapsible-content">${DOMPurify.sanitize(marked.parse(thought))}</div>`;
                                    messageDiv.insertBefore(details, contentDiv);
                                });
                                
                                contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(processedContent));
                                enhanceCodeBlocks(wrapper);
                                enhanceWithCommandButtons(wrapper);
                            }
                        }
                    }
                    break;
                case 'setGeneratingState':
                    setGeneratingState(message.isGenerating);
                    break;
                case 'startContextLoading':
                    contextStatusContainer.style.display = 'none';
                    contextLoadingSpinner.style.display = 'flex';
                    break;
                case 'displayPlan':
                    const isFinished = !message.plan || message.plan.tasks.every(t => t.status === 'completed' || t.status === 'failed');
                    setGeneratingState(!isFinished);
                    displayPlan(message.plan);
                    break;
                case 'loadDiscussion':
                    attachmentsContainer.innerHTML = '';
                    chatMessagesContainer.innerHTML = '';
                    
                    const attachmentsWrapper = document.getElementById('attachments-collapsible-wrapper');
                    attachmentsWrapper.style.display = 'none';

                    const existingPlan = chatMessagesContainer.querySelector('.plan-wrapper');
                    if (existingPlan) { existingPlan.remove(); }

                    isInspectorEnabled = message.isInspectorEnabled;

                    let hasChatContent = false;
                    if (Array.isArray(message.messages) && message.messages.length > 0) {
                        message.messages.forEach(msg => {
                            addMessage(msg);
                            if ((msg.role === 'user' || msg.role === 'assistant') && (!msg.id || !msg.id.startsWith('attachment_'))) {
                                hasChatContent = true;
                            }
                        });
                    }
                    
                    const attachmentCount = attachmentsContainer.children.length;
                    if (attachmentCount > 0) {
                        attachmentsWrapper.style.display = 'block';
                        document.getElementById('attachments-summary').textContent = `ðŸ“Ž Added Files (${attachmentCount})`;
                    } else {
                        attachmentsWrapper.style.display = 'none';
                    }

                    welcomeMessage.style.display = (attachmentCount > 0 || hasChatContent) ? 'none' : 'block';
                    setGeneratingState(false);
                    break;
                case 'resendMessage':
                    setGeneratingState(true);
                    addChatMessage(message.message);
                    vscode.postMessage({ command: 'sendMessage', message: message.message });
                    break;
                case 'updateContext':
                    updateContext(message.context);
                    break;
                case 'updateTokenProgress':
                    contextStatusContainer.style.display = 'flex';
                    contextLoadingSpinner.style.display = 'none';
                    const { totalTokens, contextSize } = message;

                    if (typeof totalTokens === 'number' && typeof contextSize === 'number' && contextSize > 0) {
                        const percentage = Math.min((totalTokens / contextSize) * 100, 100);
                        tokenProgressBar.style.width = `${percentage}%`;
                        
                        tokenProgressBar.classList.remove('green', 'yellow', 'red');
                        if (percentage > 90) {
                            tokenProgressBar.classList.add('red');
                        } else if (percentage > 75) {
                            tokenProgressBar.classList.add('yellow');
                        } else {
                            tokenProgressBar.classList.add('green');
                        }
                        
                        tokenCountLabel.textContent = `Tokens: ${totalTokens} / ${contextSize}`;
                    } else {
                        tokenCountLabel.textContent = `Tokens: Press ðŸ”ƒ to calculate`;
                        tokenProgressBar.style.width = '0%';
                    }
                    break;
                case 'updateAgentMode':
                    agentModeCheckbox.checked = message.isActive;
                    if (!message.isActive) {
                        setGeneratingState(false);
                    }
                    break;
                case 'error':
                    setGeneratingState(false);
                    addChatMessage({ id: 'error_' + Date.now(), role: 'system', content: 'âŒ Error: ' + message.content });
                    break;
                case 'setInputText':
                    messageInput.value = message.text;
                    messageInput.focus();
                    break;
                case 'imageGenerationResult':
                    const btn = document.getElementById(message.buttonId);
                    if (btn) {
                        if (message.success) {
                            btn.innerHTML = `<span class="codicon codicon-check"></span> Saved!`;
                        } else {
                            btn.innerHTML = `<span class="codicon codicon-error"></span> Failed`;
                            btn.disabled = false; // Allow retry
                        }
                    }
                    break;
            }
        });
        setGeneratingState(false);
        // --- Menu Logic ---
        moreActionsButton.addEventListener('click', (event) => {
            event.stopPropagation();
            const isVisible = moreActionsMenu.style.display === 'block';
            moreActionsMenu.style.display = isVisible ? 'none' : 'block';
        });

        window.addEventListener('click', (event) => {
            if (!moreActionsMenu.contains(event.target) && event.target !== moreActionsButton) {
                moreActionsMenu.style.display = 'none';
            }
        });

    </script>
</body>
</html>
