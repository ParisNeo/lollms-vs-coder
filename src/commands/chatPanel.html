<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lollms Chat</title>
    <link href="{{codiconsUri}}" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    
    <style>
        :root {
            --code-bg: #1e1e1e;
            --code-border: #3e3e3e;
        }
        body { 
            font-family: var(--vscode-font-family); 
            padding: 0;
            margin: 0;
            background-color: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
            overflow: hidden; /* Prevent body scroll */
        }
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .search-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background-color: var(--vscode-editorWidget-background);
            border-bottom: 1px solid var(--vscode-panel-border);
            position: sticky;
            top: -10px; /* Counteract padding */
            margin: -10px -10px 10px -10px;
            z-index: 10;
        }
        #searchInput {
            flex-grow: 1;
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            color: var(--vscode-input-foreground);
            padding: 4px 8px;
            border-radius: 4px;
        }
        #search-results-count {
            font-size: 0.9em;
            color: var(--vscode-description-foreground);
        }
        .search-bar button {
            background: none;
            border: none;
            color: var(--vscode-icon-foreground);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        .search-bar button:hover {
            background-color: var(--vscode-toolbar-hoverBackground);
        }
        mark {
            background-color: var(--vscode-editor-findMatchHighlightBackground);
            color: var(--vscode-editor-foreground);
            border-radius: 2px;
        }
        mark.current-match {
            background-color: var(--vscode-editor-findMatchBackground);
            outline: 1px solid var(--vscode-editor-findMatchBorder);
        }
        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            position: relative;
            max-width: 95%;
            width: fit-content;
        }
        .user-message {
            background-color: var(--vscode-inputOption-activeBackground);
            border-left: 4px solid var(--vscode-inputOption-activeBorder);
            align-self: flex-end;

        }
        .assistant-message {
            background-color: var(--vscode-textBlockQuote-background);
            border-left: 4px solid var(--vscode-textBlockQuote-border);
            align-self: flex-start;
        }
        .system-message {
            background-color: var(--vscode-editor-background);
            border: 1px dashed var(--vscode-panel-border);
            font-size: 0.9em;
            opacity: 0.8;
            align-self: center;
            width: 95%;
        }
        .message-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--vscode-textPreformat-foreground);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .message-content {
            line-height: 1.6;
            word-wrap: break-word;
        }
        .message-content pre {
            position: relative;
            background-color: var(--code-bg) !important;
            border: 1px solid var(--code-border);
            border-radius: 8px;
            margin: 12px 0;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .message-content pre code {
            background: transparent !important;
            padding: 16px !important;
            display: block;
            overflow-x: auto;
            font-family: var(--vscode-editor-font-family);
            font-size: 13px;
            line-height: 1.5;
            color: #D4D4D4;
        }
        .code-header {
            background-color: var(--vscode-editorGroupHeader-tabsBackground);
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--vscode-tab-activeForeground);
            border-bottom: 1px solid var(--code-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .language-label {
            background-color: var(--vscode-badge-background);
            color: var(--vscode-badge-foreground);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .code-actions {
            display: flex;
            gap: 8px;
        }
        .code-action-btn, .msg-action-btn {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .code-action-btn:hover, .msg-action-btn:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }
        .apply-btn {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        .apply-btn:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        .input-area-wrapper {
            padding: 10px;
            background-color: var(--vscode-panel-background);
            border-top: 1px solid var(--vscode-panel-border);
        }
        .top-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 8px;
        }
        .input-area {
            display: flex;
            gap: 8px;
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 6px;
            padding: 4px;
        }
        .input-area:focus-within {
            border-color: var(--vscode-focusBorder);
        }
        #messageInput {
            flex-grow: 1;
            border: none;
            background-color: transparent;
            color: var(--vscode-input-foreground);
            padding: 8px;
            font-size: 14px;
            font-family: var(--vscode-font-family);
            resize: none;
            line-height: 1.6;
            max-height: 200px;
            outline: none;
        }
        #messageInput:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .control-buttons button {
            background: none;
            border: none;
            color: var(--vscode-icon-foreground);
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 4px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .control-buttons button:hover {
            background-color: var(--vscode-toolbar-hoverBackground);
        }
        .control-buttons button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        #sendButton {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        #sendButton:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        #stopButton {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }
        #stopButton:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }
        .spinner {
            border: 2px solid var(--vscode-panel-border);
            border-top: 2px solid var(--vscode-focusBorder);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-actions {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            gap: 5px;
        }
        .message:hover .message-actions {
            display: flex;
        }
        .msg-action-btn {
            background: var(--vscode-sideBar-background);
            opacity: 0.7;
        }
        .msg-action-btn:hover {
            opacity: 1;
        }
        .agent-mode-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 15px;
            font-size: 0.9em;
            color: var(--vscode-descriptionForeground);
        }
        .agent-mode-toggle.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        .switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--vscode-input-border);
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 12px; width: 12px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--vscode-button-background); }
        input:checked + .slider:before { transform: translateX(14px); }
        
        #plan-container {
            border: 1px solid var(--vscode-panel-border);
            border-radius: 8px;
            margin-bottom: 15px;
            background-color: var(--vscode-sideBar-background);
            width: 95%;
            align-self: center;
        }
        .plan-header {
            padding: 10px 15px;
            font-weight: 600;
            border-bottom: 1px solid var(--vscode-panel-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .plan-header::before {
            content: '▶';
            transition: transform 0.2s;
            font-size: 0.8em;
        }
        details[open] > .plan-header::before {
            transform: rotate(90deg);
        }
        .plan-objective {
            font-size: 0.9em;
            font-weight: normal;
            color: var(--vscode-descriptionForeground);
            margin-top: 5px;
        }
        .plan-body {
            padding: 5px 15px 15px 15px;
        }
        .plan-task {
            padding: 8px 0;
            border-bottom: 1px solid var(--vscode-editorWidget-background);
        }
        .plan-task:last-child { border-bottom: none; }
        .plan-task-header {
            display: flex;
            align-items: center;
        }
        .task-status {
            width: 24px;
            text-align: center;
            margin-right: 10px;
            font-size: 16px;
        }
        .task-status .codicon-sync.spin { animation: spin 1.5s linear infinite; }
        .task-status .codicon-check { color: var(--vscode-testing-iconPassed); }
        .task-status .codicon-error { color: var(--vscode-testing-iconFailed); }
        .task-status .codicon-circle-large-filled { 
            color: var(--vscode-descriptionForeground); 
            font-size: 12px;
            vertical-align: middle;
         }
        
        .task-description { flex: 1; }
        .task-result-details {
            margin-top: 8px;
            padding-left: 34px;
        }
        .task-result-details summary {
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--vscode-descriptionForeground);
            list-style-position: inside;
        }
        .task-result-content {
            margin-top: 5px;
            background-color: var(--vscode-textCodeBlock-background);
            border-radius: 4px;
            padding: 8px 12px;
            max-height: 200px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: var(--vscode-editor-font-family);
            font-size: 0.9em;
        }
        details.info-collapsible {
            border: 1px solid var(--vscode-panel-border);
            border-radius: 6px;
            background-color: var(--vscode-sideBar-background);
            margin: 0 auto 15px auto;
            width: 95%;
        }
        details.info-collapsible > summary {
            padding: 10px;
            cursor: pointer;
            font-weight: 600;
            list-style: none;
        }
        details.info-collapsible > summary::-webkit-details-marker { display: none; }
        details.info-collapsible > summary::before {
            content: '▶';
            margin-right: 8px;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
        .collapsible-content {
            padding: 0 10px 10px 10px;
            background-color: var(--vscode-editor-background);
            border-top: 1px solid var(--vscode-panel-border);
            max-height: 400px;
            overflow-y: auto;
        }
        .collapsible-content pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: var(--vscode-editor-font-family);
            font-size: 0.9em;
            background-color: var(--vscode-textCodeBlock-background);
            padding: 10px;
            border-radius: 4px;
        }
        .attachment-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .remove-attachment-btn {
            background: none; border: none; cursor: pointer;
            color: var(--vscode-icon-foreground); padding: 2px 5px; border-radius: 3px;
        }
        .remove-attachment-btn:hover { background-color: var(--vscode-toolbar-hoverBackground); }
        .collapsible-content img { max-width: 100%; border-radius: 4px; margin-top: 5px; }

        #welcome-message {
            padding: 15px;
            background-color: var(--vscode-textBlockQuote-background);
            border-radius: 6px;
            margin: 0 auto 15px auto;
            font-size: 0.95em;
            width: 95%;
            border-left: 4px solid var(--vscode-focusBorder);
        }
        #welcome-message ul { padding-left: 20px; margin: 10px 0 0 0; }
        #welcome-message li { margin-bottom: 5px; }

        .plan-scratchpad {
            font-size: 0.9em;
            color: var(--vscode-descriptionForeground);
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--vscode-panel-border);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .plan-scratchpad h3 { margin-top: 0; font-size: 1em; font-weight: 600; }
        #chat-messages-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .thinking-collapsible {
            background-color: var(--vscode-editorWidget-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 6px;
            margin-bottom: 10px;
        }
    </style>
    
</head>
<body>
    <div class="chat-container">
        <div class="messages" id="messages">
            <div class="search-bar" id="search-bar" style="display: none;">
                <input type="text" id="searchInput" placeholder="Search discussion...">
                <span id="search-results-count"></span>
                <button id="search-prev" title="Previous match"><i class="codicon codicon-arrow-up"></i></button>
                <button id="search-next" title="Next match"><i class="codicon codicon-arrow-down"></i></button>
                <button id="search-close" title="Close search"><i class="codicon codicon-close"></i></button>
            </div>
            
            <div id="context-container"></div>
            <div id="attachments-container"></div>
            
            <div id="welcome-message" style="display: none;">
                <h3>{{welcomeTitle}}</h3>
                <ul>
                    <li>{{welcomeItem1}}</li>
                    <li>{{welcomeItem2}}</li>
                    <li>{{welcomeItem3}}</li>
                    <li>{{welcomeItem4}}</li>
                </ul>
            </div>

            <div id="plan-container" class="plan-container" style="display: none;"></div>

            <div id="chat-messages-container"></div>

        </div>
        <div class="input-area-wrapper">
            <div class="top-controls">
                <div class="agent-mode-toggle">
                    <span>🤖 Agent Mode</span>
                    <label class="switch">
                        <input type="checkbox" id="agentModeCheckbox">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="input-area">
                <button id="attachButton" title="Attach Files"><i class="codicon codicon-add"></i></button>
                <textarea id="messageInput" placeholder="Enter your message (Shift+Enter for new line)..." rows="1"></textarea>
                <div class="control-buttons">
                    <button id="sendButton" title="Send Message"><i class="codicon codicon-send"></i></button>
                    <button id="stopButton" title="Stop Generation" style="display: none;">
                        <div class="spinner"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none;" multiple accept=".md,.txt,.msg,.docx,.pdf,.pptx,.xlsx,.csv,.png,.jpg,.jpeg,.bmp,.webp">

    <script src="https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        const vscode = acquireVsCodeApi();
        const messagesDiv = document.getElementById('messages');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const stopButton = document.getElementById('stopButton');
        const attachButton = document.getElementById('attachButton');
        const fileInput = document.getElementById('fileInput');
        const agentModeCheckbox = document.getElementById('agentModeCheckbox');
        const agentModeToggle = document.querySelector('.agent-mode-toggle');
        const contextContainer = document.getElementById('context-container');
        const attachmentsContainer = document.getElementById('attachments-container');
        const welcomeMessage = document.getElementById('welcome-message');
        const planContainer = document.getElementById('plan-container');

        const searchBar = document.getElementById('search-bar');
        const searchInput = document.getElementById('searchInput');
        const searchResultsCount = document.getElementById('search-results-count');
        const searchPrevBtn = document.getElementById('search-prev');
        const searchNextBtn = document.getElementById('search-next');
        const searchCloseBtn = document.getElementById('search-close');

        let searchMatches = [];
        let currentMatchIndex = -1;

        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false
        });
        
        function addMessage(message) {
            if (message.id && message.id.startsWith('attachment_')) {
                addAttachment(message);
            } else {
                addChatMessage(message);
            }
        }

        function addAttachment(message) {
            if (document.querySelector(`.attachment-details[data-message-id='${message.id}']`)) return;

            const details = document.createElement('details');
            details.className = 'info-collapsible attachment-details';
            details.dataset.messageId = message.id;

            const summary = document.createElement('summary');
            summary.className = 'attachment-summary';
            const summaryText = document.createElement('span');
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-attachment-btn';
            removeBtn.innerHTML = '<i class="codicon codicon-trash"></i>';
            removeBtn.title = 'Remove Attachment';
            removeBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                vscode.postMessage({ command: 'requestDeleteMessage', messageId: message.id });
            };

            const contentDiv = document.createElement('div');
            contentDiv.className = 'collapsible-content';
            
            let fileName = 'file';
            let fileContentHtml = '';

            if (Array.isArray(message.content)) {
                const textPart = message.content.find(p => p.type === 'text');
                const imagePart = message.content.find(p => p.type === 'image_url');
                
                if (imagePart) { // Image
                    if (textPart && typeof textPart.text === 'string') {
                        fileName = textPart.text.replace('Attached image: ', '');
                    }
                    summaryText.textContent = `📎 Attached Image: ${fileName}`;
                    fileContentHtml = `<img src="${imagePart.image_url.url}" alt="${fileName}">`;
                } else { // Text file (messy structure)
                    const titlePart = message.content[0];
                    const contentPart = message.content[1];
                    if (titlePart && typeof titlePart.text === 'string') {
                         fileName = titlePart.text.replace('Attached file: ', '').trim();
                    }
                    summaryText.textContent = `📎 Attached File: ${fileName}`;
                    
                    let code = 'Could not display file content.';
                    if(contentPart && typeof contentPart.text === 'string') {
                        const codeBlockRegex = /```\\n([\\s\\S]+?)\\n```/; // Adjusted regex for escaped newlines
                        const match = contentPart.text.match(codeBlockRegex);
                        if (match && match[1]) {
                            code = match[1].replace(/\\n/g, '\\n');
                        } else {
                            code = contentPart.text.replace(/^```\w*\\n|\\n```$/g, '').replace(/\\n/g, '\\n');
                        }
                    }
                    fileContentHtml = `<pre>${DOMPurify.sanitize(code)}</pre>`;
                }

            }
            
            summary.appendChild(summaryText);
            summary.appendChild(removeBtn);
            contentDiv.innerHTML = fileContentHtml;
            details.appendChild(summary);
            details.appendChild(contentDiv);
            attachmentsContainer.appendChild(details);
        }

        function processThinkTags(content) {
            const thoughts = [];
            const thinkRegex = /<(think|thinking)>([\s\S]*?)<\/\1>/g;
            const processedContent = content.replace(thinkRegex, (match, tag, thoughtContent) => {
                thoughts.push(thoughtContent);
                return ''; // Remove the block from the main content
            });
            return { thoughts, processedContent: processedContent.trim() };
        }

        function addChatMessage(message) {
            const role = message.role;
            let content = message.content;
            
            const existingMsgWrapper = chatMessagesContainer.querySelector(`.message-wrapper[data-message-id='${message.id}']`);
            if (existingMsgWrapper) {
                const contentDiv = existingMsgWrapper.querySelector('.message-content');
                if (contentDiv) {
                    contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(content));
                    enhanceCodeBlocks(contentDiv);
                }
                return;
            }

            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper';
            messageWrapper.dataset.messageId = message.id;

            let thoughtsHtml = '';
            if (role === 'assistant') {
                const { thoughts, processedContent } = processThinkTags(content);
                content = processedContent;
                if (thoughts.length > 0) {
                    thoughts.forEach(thought => {
                        thoughtsHtml += `
                            <details class="info-collapsible thinking-collapsible">
                                <summary>🤔 Thinking Process</summary>
                                <div class="collapsible-content">${DOMPurify.sanitize(marked.parse(thought))}</div>
                            </details>
                        `;
                    });
                }
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            headerDiv.textContent = role;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(content));

            messageDiv.appendChild(headerDiv);
            messageDiv.innerHTML += thoughtsHtml; // Add thoughts right after the header
            messageDiv.appendChild(contentDiv);
            
            messageWrapper.appendChild(messageDiv);
            chatMessagesContainer.appendChild(messageWrapper);
            
            enhanceCodeBlocks(messageWrapper); // Enhance code blocks within the entire wrapper
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function updateContext(contextText) {
            contextContainer.innerHTML = '';
            if (contextText && contextText.trim() !== '') {
                contextContainer.innerHTML = `
                    <details class="info-collapsible">
                        <summary>View AI Context</summary>
                        <div class="collapsible-content">
                            <pre>${DOMPurify.sanitize(contextText)}</pre>
                        </div>
                    </details>
                `;
            }
        }
        
        function getStatusIcon(status) {
            switch(status) {
                case 'pending': return '<span class="codicon codicon-circle-large-filled"></span>';
                case 'in_progress': return '<span class="codicon codicon-sync spin"></span>';
                case 'completed': return '<span class="codicon codicon-check"></span>';
                case 'failed': return '<span class="codicon codicon-error"></span>';
                default: return '<span class="codicon codicon-circle-slash"></span>';
            }
        }
        
        function enhanceCodeBlocks(container) {
            container.querySelectorAll('pre').forEach(pre => {
                const codeBlock = pre.querySelector('code');
                if (!codeBlock) return;
        
                let header = pre.previousElementSibling;
                if(header && header.classList.contains('code-header')){
                    header.remove();
                }

                header = document.createElement('div');
                header.className = 'code-header';
                
                const codeContent = codeBlock.innerText;
                
                let language = [...codeBlock.classList]
                    .find(c => c.startsWith('language-'))
                    ?.replace('language-', '').toLowerCase() || '';

                header.innerHTML = `<span class="language-label">${language || 'text'}</span>`;
                
                const actions = document.createElement('div');
                actions.className = 'code-actions';

                // [NEW] Logic to find and add Apply button
                const previousElement = pre.previousElementSibling;
                if (previousElement && previousElement.tagName === 'P') {
                    const text = (previousElement.textContent || '').trim();
                    const fileMatch = text.match(/^File:\s*(.+)$/i);
                    const patchMatch = text.match(/^(Patch|diff):\s*(.+)$/i);
                    let matchInfo = null;
                    if (fileMatch) {
                        matchInfo = { type: 'applyFileContent', path: fileMatch[1].trim(), label: 'Apply to File' };
                    } else if (patchMatch) {
                        matchInfo = { type: 'applyPatchContent', path: patchMatch[2].trim(), label: 'Apply Patch' };
                    }

                    if (matchInfo) {
                        previousElement.style.display = 'none'; // Hide the directive line
                        const applyBtn = document.createElement('button');
                        applyBtn.className = 'code-action-btn apply-btn';
                        applyBtn.innerHTML = '⚙️ ' + matchInfo.label;
                        applyBtn.title = `Write changes to ${matchInfo.path}`;
                        applyBtn.onclick = () => {
                            vscode.postMessage({
                                command: matchInfo.type,
                                filePath: matchInfo.path,
                                content: codeBlock.innerText
                            });
                        };
                        actions.insertBefore(applyBtn, actions.firstChild);
                    }
                }
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-action-btn';
                copyBtn.innerHTML = '📋 Copy';
                copyBtn.title = 'Copy Code';
                copyBtn.onclick = async () => {
                    await navigator.clipboard.writeText(codeContent);
                    copyBtn.innerHTML = '✅ Copied!';
                    setTimeout(() => { copyBtn.innerHTML = '📋 Copy'; }, 2000);
                };
                actions.appendChild(copyBtn);

                header.appendChild(actions);
                pre.parentNode.insertBefore(header, pre);
                
                Prism.highlightElement(codeBlock);
            });
        }

        function setGeneratingState(isGenerating) {
            messageInput.disabled = isGenerating;
            agentModeCheckbox.disabled = isGenerating;
            agentModeToggle.classList.toggle('disabled', isGenerating);
            attachButton.disabled = isGenerating;

            sendButton.style.display = isGenerating ? 'none' : 'flex';
            stopButton.style.display = isGenerating ? 'flex' : 'none';
        }

        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText) return;

            setGeneratingState(true);
            
            const messageId = 'user_' + Date.now().toString() + Math.random().toString(36).substring(2);
            const userMessage = { id: messageId, role: 'user', content: messageText };
            
            addChatMessage(userMessage);

            if (agentModeCheckbox.checked) {
                vscode.postMessage({ command: 'runAgent', objective: messageText, message: userMessage });
            } else {
                vscode.postMessage({ command: 'sendMessage', message: userMessage });
            }
            messageInput.value = '';
            messageInput.style.height = 'auto';
        }
        
        attachButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            if (!fileInput.files) return;
            for (const file of fileInput.files) {
                const reader = new FileReader();
                const isImage = ['image/png', 'image/jpeg', 'image/bmp', 'image/gif', 'image/webp'].includes(file.type);
                
                reader.onload = (e) => {
                    vscode.postMessage({
                        command: 'loadFile',
                        file: {
                            name: file.name,
                            content: e.target.result,
                            isImage: isImage
                        }
                    });
                };
                
                reader.readAsDataURL(file);
            }
            fileInput.value = '';
        });

        agentModeCheckbox.addEventListener('change', () => {
            vscode.postMessage({ command: 'toggleAgentMode' });
        });

        sendButton.addEventListener('click', sendMessage);
        stopButton.addEventListener('click', () => {
            vscode.postMessage({ command: 'stopGeneration' });
        });

        messageInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
        
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = (messageInput.scrollHeight) + 'px';
        });

        function clearSearch() { /* ... function unchanged ... */ }
        function performSearch() { /* ... function unchanged ... */ }
        function updateSearchCount() { /* ... function unchanged ... */ }
        function navigateSearch(direction) { /* ... function unchanged ... */ }
        
        function displayPlan(plan) {
            planContainer.innerHTML = '';
            if (!plan) {
                planContainer.style.display = 'none';
                return;
            }
            
            let tasksHtml = plan.tasks.map(task => {
                const resultHtml = task.result ? `
                    <div class="task-result-details">
                        <details ${task.status === 'failed' ? 'open' : ''}>
                            <summary>View Details</summary>
                            <div class="task-result-content">${DOMPurify.sanitize(task.result)}</div>
                        </details>
                    </div>
                ` : '';
                return `
                    <div class="plan-task" data-task-id="${task.id}">
                        <div class="plan-task-header">
                           <div class="task-status">${getStatusIcon(task.status)}</div>
                            <div class="task-description">
                                <strong>${task.id ? task.id + '.' : ''} ${DOMPurify.sanitize(task.description)}</strong>
                            </div>
                        </div>
                        ${resultHtml}
                    </div>`;
            }).join('');
            
            const scratchpadHtml = plan.scratchpad ? `
                <div class="plan-scratchpad">
                    <h3>Agent Scratchpad</h3>
                    ${DOMPurify.sanitize(marked.parse(plan.scratchpad))}
                </div>
            ` : '';

            planContainer.innerHTML = `
                <details open>
                    <summary class="plan-header">📝 Agent Execution Plan</summary>
                    <div class="plan-body">
                       <div class="plan-objective"><b>Objective:</b> ${DOMPurify.sanitize(plan.objective)}</div>
                       ${tasksHtml}
                       ${scratchpadHtml}
                    </div>
                </details>
            `;
            planContainer.style.display = 'block';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        document.addEventListener('keydown', e => { /* ... function unchanged ... */ });

        searchInput.addEventListener('input', performSearch);
        searchNextBtn.addEventListener('click', () => navigateSearch(1));
        searchPrevBtn.addEventListener('click', () => navigateSearch(-1));
        searchCloseBtn.addEventListener('click', () => {
            searchBar.style.display = 'none';
            clearSearch();
        });

        window.addEventListener('message', event => {
          const message = event.data;

          switch(message.command) {
            case 'addMessage':
                setGeneratingState(false);
                addMessage(message.message);
                break;
            case 'displayPlan':
                const isFinished = !message.plan || message.plan.tasks.every(t => t.status === 'completed' || t.status === 'failed');
                setGeneratingState(!isFinished);
                displayPlan(message.plan);
                break;
            case 'loadDiscussion':
                attachmentsContainer.innerHTML = '';
                chatMessagesContainer.innerHTML = '';
                planContainer.style.display = 'none';

                let hasChatContent = false;
                if (Array.isArray(message.messages) && message.messages.length > 0) {
                    message.messages.forEach(msg => {
                        addMessage(msg);
                        if ((msg.role === 'user' || msg.role === 'assistant') && (!msg.id || !msg.id.startsWith('attachment_'))) {
                            hasChatContent = true;
                        }
                    });
                }
                
                welcomeMessage.style.display = (attachmentsContainer.hasChildNodes() || hasChatContent) ? 'none' : 'block';
                setGeneratingState(false);
                break;
            case 'resendMessage':
                 setGeneratingState(true);
                 addChatMessage(message.message);
                 vscode.postMessage({ command: 'sendMessage', message: message.message });
                 break;
            case 'updateContext':
                updateContext(message.context);
                break;
            case 'updateAgentMode':
                agentModeCheckbox.checked = message.isActive;
                if (!message.isActive) {
                    setGeneratingState(false);
                }
                break;
            case 'error':
                setGeneratingState(false);
                addChatMessage({ role: 'system', content: '❌ Error: ' + message.content });
                break;
          }
        });
        setGeneratingState(false);
    </script>
</body>
</html>